---
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Lottery Sphere</title>
		<style>
			body {
				margin: 0;
				overflow: hidden;
				background-color: #111; /* Dark background to make names pop */
				font-family: system-ui, sans-serif;
				color: white;
			}
			#sphere-container {
				width: 100vw;
				height: 100vh;
				position: relative;
			}
			canvas {
				display: block;
				width: 100%;
				height: 100%;
			}
			
			/* UI Overlay */
			#ui-layer {
				position: absolute;
				bottom: 40px;
				left: 50%;
				transform: translateX(-50%);
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 20px;
				z-index: 10;
				pointer-events: none; /* Let clicks pass through to canvas if needed, but buttons need pointer-events auto */
			}
			
			button {
				pointer-events: auto;
				padding: 12px 32px;
				font-size: 1.2rem;
				font-weight: bold;
				color: #fff;
				background: linear-gradient(45deg, #ff3366, #ff6b6b);
				border: none;
				border-radius: 50px;
				cursor: pointer;
				box-shadow: 0 4px 15px rgba(255, 51, 102, 0.4);
				transition: transform 0.2s, box-shadow 0.2s;
				text-transform: uppercase;
				letter-spacing: 1px;
			}
			
			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(255, 51, 102, 0.6);
			}
			
			button:active {
				transform: translateY(1px);
			}
			
			button:disabled {
				background: #555;
				cursor: not-allowed;
				box-shadow: none;
				transform: none;
			}

			#status-display {
				font-size: 1.5rem;
				font-weight: bold;
				text-shadow: 0 2px 4px rgba(0,0,0,0.8);
				min-height: 2rem;
			}

            /* Winners List */
            #winners-list-container {
                position: absolute;
                top: 20px;
                right: 20px;
                width: 250px;
                max-height: 50vh;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                border-radius: 12px;
                padding: 15px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                overflow-y: auto;
                pointer-events: auto;
            }
            
            #winners-list-container h3 {
                margin: 0 0 10px 0;
                font-size: 1rem;
                color: #aaa;
                text-transform: uppercase;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding-bottom: 5px;
            }
            
            #winners-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            #winners-list li {
                padding: 5px 0;
                font-size: 1.1rem;
                color: #ffd700;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            #winners-list li::before {
                content: '‚òÖ';
                font-size: 0.8rem;
                color: #ff3366;
            }

            /* Result Modal Overlay */
            #modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(3px);
                z-index: 100;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            
            #modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

			#result-modal {
				background: rgba(20, 20, 20, 0.95);
				padding: 50px 80px;
				border-radius: 20px;
				border: 1px solid rgba(255, 255, 255, 0.2);
				text-align: center;
				box-shadow: 0 0 50px rgba(0,0,0,0.5);
				transform: scale(0.9);
				transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			}
			
            #modal-overlay.visible #result-modal {
                transform: scale(1);
            }
			
			.winner-title {
				font-size: 1.5rem;
				color: #fff;
				margin-bottom: 20px;
				text-transform: uppercase;
				letter-spacing: 2px;
			}
			
			.winner-name {
				font-size: 4rem;
				font-weight: 800;
				background: linear-gradient(45deg, #ffd700, #ffaa00, #ffea00);
                background-size: 200% auto;
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				margin: 0;
                animation: shine 3s linear infinite;
			}
            
            @keyframes shine {
                to {
                    background-position: 200% center;
                }
            }

			.next-btn {
				margin-top: 40px;
                padding: 15px 40px;
                font-size: 1.3rem;
                background: white;
                color: #111;
			}
			
			.next-btn:hover {
                background: #eee;
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
			}

            /* Settings Button */
            #settings-btn {
                position: absolute;
                top: 20px;
                left: 20px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                padding: 10px 20px;
                border-radius: 30px;
                color: white;
                font-size: 0.9rem;
                cursor: pointer;
                z-index: 20;
                transition: all 0.2s;
            }
            #settings-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            /* Settings Modal */
            #settings-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 200;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            #settings-modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            #settings-modal {
                background: #1a1a1a;
                width: 600px;
                max-width: 90%;
                border-radius: 12px;
                padding: 30px;
                border: 1px solid #333;
                display: flex;
                flex-direction: column;
                gap: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            }
            #settings-modal h3 {
                margin: 0;
                color: #fff;
            }
            #names-input {
                width: 100%;
                height: 300px;
                background: #111;
                border: 1px solid #333;
                color: #eee;
                padding: 15px;
                border-radius: 8px;
                resize: vertical;
                font-family: monospace;
                font-size: 14px;
                box-sizing: border-box;
            }
            #names-input:focus {
                outline: none;
                border-color: #ff3366;
            }
            .stats-bar {
                display: flex;
                gap: 15px;
                color: #888;
                font-size: 0.9rem;
            }
            .separator { color: #444; }
            strong { color: #fff; }

            .warning-box {
                background: rgba(255, 165, 0, 0.1);
                border: 1px solid rgba(255, 165, 0, 0.3);
                color: #ffaa00;
                padding: 10px;
                border-radius: 6px;
                font-size: 0.9rem;
                word-break: break-all;
            }
            .error-box {
                background: rgba(255, 51, 102, 0.1);
                border: 1px solid rgba(255, 51, 102, 0.3);
                color: #ff3366;
                padding: 10px;
                border-radius: 6px;
                font-size: 0.9rem;
            }
            .hidden { display: none; }

            .modal-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 10px;
            }
            .secondary-btn {
                background: #333;
                color: #ccc;
                box-shadow: none;
            }
            .secondary-btn:hover {
                background: #444;
                transform: none;
                box-shadow: none;
            }
		</style>
	</head>
	<body>
		<div id="sphere-container">
            <button id="settings-btn">‚öôÔ∏è ËÆæÁΩÆÂêçÂçï</button>
			<canvas id="lottery-canvas"></canvas>
			
			<div id="ui-layer">
				<div id="status-display">ÂáÜÂ§áÂ∞±Áª™</div>
				<button id="start-btn">ÂºÄÂßãÊäΩÂ•ñ</button>
			</div>
            
            <div id="winners-list-container">
                <h3>Â∑≤‰∏≠Â•ñÂêçÂçï</h3>
                <ul id="winners-list">
                    <!-- Winners will be added here -->
                </ul>
            </div>
			
            <div id="modal-overlay">
                <div id="result-modal">
                    <div class="winner-title">üéâ ÊÅ≠Âñú üéâ</div>
                    <h2 class="winner-name" id="winner-name">---</h2>
                    <button class="next-btn" id="next-btn">‰∏ã‰∏Ä‰Ωç</button>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal-overlay">
                <div id="settings-modal">
                    <h3>ËÆæÁΩÆÂêçÂçï</h3>
                    <div class="input-group">
                        <textarea id="names-input" placeholder="ËØ∑ËæìÂÖ•ÊàñÁ≤òË¥¥ÂßìÂêçÔºåÊØèË°å‰∏Ä‰∏™..."></textarea>
                    </div>
                    <div class="stats-bar">
                        <span>Â∑≤ÂØºÂÖ•: <strong id="valid-count">0</strong> ‰∫∫</span>
                        <span class="separator">|</span>
                        <span class="text-muted">ÂéüÂßã: <span id="raw-count">0</span> Ë°å</span>
                    </div>
                    <div id="duplicate-warning" class="warning-box hidden">
                        ‚ö†Ô∏è Ê£ÄÊµãÂà∞ÈáçÂ§çÂßìÂêçÔºö<span id="dup-list"></span>
                    </div>
                    <div id="empty-error" class="error-box hidden">
                        ‚ùå ÂêçÂçï‰∏çËÉΩ‰∏∫Á©∫
                    </div>
                    <div class="modal-actions">
                        <button id="cancel-settings-btn" class="secondary-btn">ÂèñÊ∂à</button>
                        <button id="apply-settings-btn" class="primary-btn">Â∫îÁî®ÂêçÂçï</button>
                    </div>
                </div>
            </div>
		</div>

		<script>
			import { LotterySphere } from '../components/LotterySphere';
			import names from '../data/name';

			const canvas = document.getElementById('lottery-canvas') as HTMLCanvasElement;
			const startBtn = document.getElementById('start-btn') as HTMLButtonElement;
			const statusDisplay = document.getElementById('status-display') as HTMLDivElement;
			const modalOverlay = document.getElementById('modal-overlay') as HTMLDivElement;
			const winnerNameEl = document.getElementById('winner-name') as HTMLHeadingElement;
			const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
            const winnersList = document.getElementById('winners-list') as HTMLUListElement;

            // Settings Elements
            const settingsBtn = document.getElementById('settings-btn') as HTMLButtonElement;
            const settingsOverlay = document.getElementById('settings-modal-overlay') as HTMLDivElement;
            const cancelSettingsBtn = document.getElementById('cancel-settings-btn') as HTMLButtonElement;
            const applySettingsBtn = document.getElementById('apply-settings-btn') as HTMLButtonElement;
            const namesInput = document.getElementById('names-input') as HTMLTextAreaElement;
            const validCountEl = document.getElementById('valid-count') as HTMLElement;
            const rawCountEl = document.getElementById('raw-count') as HTMLElement;
            const dupWarningEl = document.getElementById('duplicate-warning') as HTMLDivElement;
            const dupListEl = document.getElementById('dup-list') as HTMLElement;
            const emptyErrorEl = document.getElementById('empty-error') as HTMLDivElement;
			
			let sphere: LotterySphere | null = null;
			let isLotteryRunning = false;
            let currentNamesList = [...names]; // Copy initial names

			if (canvas) {
				// Initialize the sphere
				sphere = new LotterySphere(canvas, currentNamesList);
			}
            
            // Clean up resources when the page is unloaded
            window.addEventListener('beforeunload', () => {
                if (sphere) {
                    sphere.destroy();
                }
            });

			function updateStatus(text: string) {
				if (statusDisplay) statusDisplay.textContent = text;
			}
            
            function addWinnerToList(name: string) {
                if (!winnersList) return;
                const li = document.createElement('li');
                li.textContent = name;
                // Insert at the top
                winnersList.insertBefore(li, winnersList.firstChild);
            }

            // --- Settings Logic ---

            function processInput() {
                if (!namesInput) return [];
                const rawText = namesInput.value;
                const lines = rawText.split('\n');
                const rawCount = lines.length;
                
                const validNames: string[] = [];
                const duplicates: string[] = [];
                const seen = new Set<string>();
                
                lines.forEach(line => {
                    // Clean: trim, merge spaces
                    const clean = line.trim().replace(/\s+/g, ' ');
                    if (!clean) return;
                    
                    if (seen.has(clean)) {
                        duplicates.push(clean);
                    } else {
                        seen.add(clean);
                        validNames.push(clean);
                    }
                });
                
                // Update UI
                if (rawCountEl) rawCountEl.textContent = rawCount.toString();
                if (validCountEl) validCountEl.textContent = validNames.length.toString();
                
                // Duplicates
                if (duplicates.length > 0) {
                    dupWarningEl?.classList.remove('hidden');
                    // Top 10
                    const top10 = duplicates.slice(0, 10);
                    let msg = top10.join(', ');
                    if (duplicates.length > 10) msg += ' Á≠â';
                    if (dupListEl) dupListEl.textContent = msg;
                } else {
                    dupWarningEl?.classList.add('hidden');
                }
                
                // Empty check
                if (validNames.length === 0) {
                    emptyErrorEl?.classList.remove('hidden');
                    if (applySettingsBtn) applySettingsBtn.disabled = true;
                } else {
                    emptyErrorEl?.classList.add('hidden');
                    if (applySettingsBtn) applySettingsBtn.disabled = false;
                }
                
                return validNames;
            }

            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    if (settingsOverlay) settingsOverlay.classList.add('visible');
                    // Pre-fill with current names
                    if (namesInput) {
                        namesInput.value = currentNamesList.join('\n');
                        processInput();
                    }
                });
            }

            if (cancelSettingsBtn) {
                cancelSettingsBtn.addEventListener('click', () => {
                    if (settingsOverlay) settingsOverlay.classList.remove('visible');
                });
            }

            if (namesInput) {
                namesInput.addEventListener('input', processInput);
            }

            if (applySettingsBtn) {
                applySettingsBtn.addEventListener('click', () => {
                    const newNames = processInput();
                    if (newNames.length === 0) return;
                    
                    currentNamesList = newNames;
                    
                    if (sphere) {
                        sphere.setNames(newNames);
                    }
                    
                    // Reset winners list
                    if (winnersList) winnersList.innerHTML = '';
                    
                    // Enable start button
                    if (startBtn) startBtn.disabled = false;
                    updateStatus('ÂáÜÂ§áÂ∞±Áª™');
                    
                    if (settingsOverlay) settingsOverlay.classList.remove('visible');
                });
            }

            // --- End Settings Logic ---

			if (startBtn && sphere) {
				startBtn.addEventListener('click', () => {
					if (isLotteryRunning) return;
					
					isLotteryRunning = true;
					startBtn.disabled = true;
					updateStatus('ÊäΩÂ•ñ‰∏≠...');
					
					sphere?.startLottery((winner) => {
						isLotteryRunning = false;
						// Don't enable start btn yet, wait for "Next"
						updateStatus('ÊäΩÂ•ñÁªìÊùü');
						
						// Show result
						if (winnerNameEl) winnerNameEl.textContent = winner;
						modalOverlay.classList.add('visible');
                        
                        // Add to list immediately or after close? 
                        // Let's add immediately so it's there when they look back
                        addWinnerToList(winner);
					});
				});
			}
			
			if (nextBtn) {
				nextBtn.addEventListener('click', () => {
					modalOverlay.classList.remove('visible');
					updateStatus('ÂáÜÂ§áÂ∞±Áª™');
                    startBtn.disabled = false;
                    
                    // Remove winner from sphere
                    const winnerName = winnerNameEl.textContent;
                    if (winnerName && sphere) {
                        sphere.removeWinner(winnerName);
                    }
				});
			}
		</script>
	</body>
</html>
