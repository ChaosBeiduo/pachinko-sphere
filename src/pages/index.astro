---
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Lottery Sphere</title>
		<style>
			body {
				margin: 0;
				overflow: hidden;
				background-color: #111; /* Dark background to make names pop */
				font-family: system-ui, sans-serif;
				color: white;
			}
			#sphere-container {
				width: 100vw;
				height: 100vh;
				position: relative;
			}
			canvas {
				display: block;
				width: 100%;
				height: 100%;
			}
			
			/* UI Overlay */
			#ui-layer {
				position: absolute;
				bottom: 40px;
				left: 50%;
				transform: translateX(-50%);
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 20px;
				z-index: 10;
				pointer-events: none;
			}
            
            .control-panel {
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(10px);
                padding: 20px 40px;
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                pointer-events: auto;
            }

            .prize-selector {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 10px;
            }

            #prize-select {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                font-size: 1rem;
                outline: none;
                cursor: pointer;
            }

            #prize-select option {
                background: #222;
                color: white;
            }

            .prize-info {
                font-size: 0.9rem;
                color: #ccc;
            }

            #draw-count {
                color: #ff3366;
                font-weight: bold;
                font-size: 1.1rem;
            }
			
			button {
				pointer-events: auto;
				padding: 12px 32px;
				font-size: 1.2rem;
				font-weight: bold;
				color: #fff;
				background: linear-gradient(45deg, #ff3366, #ff6b6b);
				border: none;
				border-radius: 50px;
				cursor: pointer;
				box-shadow: 0 4px 15px rgba(255, 51, 102, 0.4);
				transition: transform 0.2s, box-shadow 0.2s;
				text-transform: uppercase;
				letter-spacing: 1px;
			}
			
			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(255, 51, 102, 0.6);
			}
			
			button:active {
				transform: translateY(1px);
			}
			
			button:disabled {
				background: #555;
				cursor: not-allowed;
				box-shadow: none;
				transform: none;
			}

			#status-display {
				font-size: 1.5rem;
				font-weight: bold;
				text-shadow: 0 2px 4px rgba(0,0,0,0.8);
				min-height: 2rem;
			}

            /* Winners Panel */
            #winners-panel {
                position: absolute;
                top: 80px;
                right: 20px;
                width: 260px;
                max-height: calc(100vh - 100px);
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                border-radius: 12px;
                padding: 15px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: column;
                pointer-events: auto;
                z-index: 5;
            }
            
            #winners-panel h3 {
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding-bottom: 10px;
                color: #fff;
            }
            
            #winners-container {
                flex: 1;
                overflow-y: auto;
                margin-bottom: 15px;
            }
            
            .winner-group {
                margin-bottom: 15px;
            }
            
            .winner-group h4 {
                margin: 0 0 5px 0;
                font-size: 0.9rem;
                color: #aaa;
                text-transform: uppercase;
            }
            
            .winner-group-list {
                color: #ffd700;
                font-size: 0.95rem;
                line-height: 1.4;
                word-break: break-all;
            }

            /* Result Modal Overlay */
            #modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(3px);
                z-index: 100;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            
            #modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

			#result-modal {
				background: rgba(20, 20, 20, 0.95);
				padding: 50px 80px;
				border-radius: 20px;
				border: 1px solid rgba(255, 255, 255, 0.2);
				text-align: center;
				box-shadow: 0 0 50px rgba(0,0,0,0.5);
				transform: scale(0.9);
				transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			}
			
            #modal-overlay.visible #result-modal {
                transform: scale(1);
            }
			
			.winner-title {
				font-size: 1.5rem;
				color: #fff;
				margin-bottom: 20px;
				text-transform: uppercase;
				letter-spacing: 2px;
			}
			
			.winner-name {
				font-size: 4rem;
				font-weight: 800;
				background: linear-gradient(45deg, #ffd700, #ffaa00, #ffea00);
                background-size: 200% auto;
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				margin: 0;
                animation: shine 3s linear infinite;
			}
            
            @keyframes shine {
                to {
                    background-position: 200% center;
                }
            }

			.next-btn {
				margin-top: 40px;
                padding: 15px 40px;
                font-size: 1.3rem;
                background: white;
                color: #111;
			}
			
			.next-btn:hover {
                background: #eee;
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
			}

            /* Result Modal Badges */
            #modal-winners-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
                margin: 30px 0;
            }

            .badge {
                background: rgba(255, 215, 0, 0.2);
                border: 1px solid rgba(255, 215, 0, 0.5);
                color: #ffd700;
                padding: 10px 20px;
                border-radius: 50px;
                font-size: 1.5rem;
                font-weight: bold;
                animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            @keyframes popIn {
                from { transform: scale(0); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }

            .highlight-name {
                font-size: 3rem;
                color: #fff;
                font-weight: bold;
                height: 4rem;
                margin-bottom: 20px;
                text-shadow: 0 0 20px rgba(255, 51, 102, 0.8);
            }

            .highlight-name.pop {
                animation: popScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            @keyframes popScale {
                0% { transform: scale(1); }
                50% { transform: scale(1.5); }
                100% { transform: scale(1); }
            }

            /* Prize Config Modal */
            #prize-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 200;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            #prize-modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

            #prize-modal {
                background: #1a1a1a;
                width: 500px;
                max-width: 90%;
                border-radius: 12px;
                padding: 30px;
                border: 1px solid #333;
                display: flex;
                flex-direction: column;
                gap: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            }

            #prize-modal h3 {
                margin: 0;
                color: #fff;
            }

            #prize-list {
                max-height: 300px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .prize-config-row {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .prize-title-input {
                flex: 2;
                background: #222;
                border: 1px solid #444;
                color: white;
                padding: 8px;
                border-radius: 4px;
            }

            .prize-count-input {
                flex: 1;
                background: #222;
                border: 1px solid #444;
                color: white;
                padding: 8px;
                border-radius: 4px;
            }

            .delete-prize-btn {
                background: transparent;
                border: none;
                cursor: pointer;
                font-size: 1.2rem;
                padding: 5px;
                transition: transform 0.2s;
            }

            .delete-prize-btn:hover {
                transform: scale(1.1);
            }

            .dashed-btn {
                background: transparent;
                border: 2px dashed #444;
                color: #888;
                border-radius: 8px;
                padding: 10px;
                cursor: pointer;
                transition: all 0.2s;
                text-transform: none;
                letter-spacing: normal;
                font-size: 1rem;
            }

            .dashed-btn:hover {
                border-color: #666;
                color: #aaa;
                background: rgba(255, 255, 255, 0.05);
                transform: none;
                box-shadow: none;
            }

            .primary-btn {
                background: linear-gradient(45deg, #ff3366, #ff6b6b);
                color: white;
                border: none;
                border-radius: 6px;
                padding: 10px 20px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(255, 51, 102, 0.3);
                font-size: 1rem;
                text-transform: none;
                letter-spacing: normal;
            }

            .primary-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 51, 102, 0.5);
            }
            
            .small {
                padding: 5px 15px;
                font-size: 0.8rem;
                border-radius: 6px;
                text-transform: none;
                letter-spacing: normal;
            }

            /* Settings Button */
            #settings-btn {
                position: absolute;
                top: 20px;
                left: 20px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                padding: 10px 20px;
                border-radius: 30px;
                color: white;
                font-size: 0.9rem;
                cursor: pointer;
                z-index: 20;
                transition: all 0.2s;
            }
            #settings-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            /* Settings Modal */
            #settings-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 200;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            #settings-modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            #settings-modal {
                background: #1a1a1a;
                width: 600px;
                max-width: 90%;
                border-radius: 12px;
                padding: 30px;
                border: 1px solid #333;
                display: flex;
                flex-direction: column;
                gap: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            }
            #settings-modal h3 {
                margin: 0;
                color: #fff;
            }
            #names-input {
                width: 100%;
                height: 300px;
                background: #111;
                border: 1px solid #333;
                color: #eee;
                padding: 15px;
                border-radius: 8px;
                resize: vertical;
                font-family: monospace;
                font-size: 14px;
                box-sizing: border-box;
            }
            #names-input:focus {
                outline: none;
                border-color: #ff3366;
            }
            .stats-bar {
                display: flex;
                gap: 15px;
                color: #888;
                font-size: 0.9rem;
            }
            .separator { color: #444; }
            strong { color: #fff; }

            .warning-box {
                background: rgba(255, 165, 0, 0.1);
                border: 1px solid rgba(255, 165, 0, 0.3);
                color: #ffaa00;
                padding: 10px;
                border-radius: 6px;
                font-size: 0.9rem;
                word-break: break-all;
            }
            .error-box {
                background: rgba(255, 51, 102, 0.1);
                border: 1px solid rgba(255, 51, 102, 0.3);
                color: #ff3366;
                padding: 10px;
                border-radius: 6px;
                font-size: 0.9rem;
            }
            .hidden { display: none; }

            .modal-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 10px;
            }
            .secondary-btn {
                background: #333;
                color: #ccc;
                box-shadow: none;
            }
            .secondary-btn:hover {
                background: #444;
                transform: none;
                box-shadow: none;
            }
		</style>
	</head>
	<body>
		<div id="sphere-container">
            <div id="top-bar">
                <button id="settings-btn">‚öôÔ∏è ËÆæÁΩÆÂêçÂçï</button>
                <button id="prizes-btn">üèÜ Â•ñÈ°πÈÖçÁΩÆ</button>
            </div>
			<canvas id="lottery-canvas"></canvas>
			
			<div id="ui-layer">
                <div class="control-panel">
                    <div class="prize-selector">
                        <select id="prize-select">
                            <!-- Prizes will be populated here -->
                        </select>
                        <div class="prize-info">
                            Êú¨Ê¨°ÊäΩÂèñ <span id="draw-count">0</span> ‰∫∫
                        </div>
                    </div>
                    <div id="status-display">ÂáÜÂ§áÂ∞±Áª™</div>
                    <button id="start-btn">ÂºÄÂßãÊäΩÂ•ñ</button>
                </div>
			</div>
            
            <div id="winners-panel">
                <h3>‰∏≠Â•ñÁªìÊûú</h3>
                <div id="winners-container">
                    <!-- Results grouped by prize -->
                </div>
                <button id="clear-results-btn" class="secondary-btn small">Ê∏ÖÁ©∫ÁªìÊûú</button>
            </div>
			
            <div id="modal-overlay">
                <div id="result-modal">
                    <div class="winner-title" id="modal-title">üéâ ÊÅ≠Âñú üéâ</div>
                    <div id="modal-winners-list">
                        <!-- Winners shown here -->
                    </div>
                    <div id="current-highlight" class="highlight-name"></div>
                    <button class="next-btn" id="next-btn">‰∏ã‰∏ÄËΩÆ</button>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal-overlay">
                <div id="settings-modal">
                    <h3>ËÆæÁΩÆÂêçÂçï</h3>
                    <div class="input-group">
                        <textarea id="names-input" placeholder="ËØ∑ËæìÂÖ•ÊàñÁ≤òË¥¥ÂßìÂêçÔºåÊØèË°å‰∏Ä‰∏™..."></textarea>
                    </div>
                    <div class="stats-bar">
                        <span>Â∑≤ÂØºÂÖ•: <strong id="valid-count">0</strong> ‰∫∫</span>
                        <span class="separator">|</span>
                        <span class="text-muted">ÂéüÂßã: <span id="raw-count">0</span> Ë°å</span>
                    </div>
                    <div id="duplicate-warning" class="warning-box hidden">
                        ‚ö†Ô∏è Ê£ÄÊµãÂà∞ÈáçÂ§çÂßìÂêçÔºö<span id="dup-list"></span>
                    </div>
                    <div id="empty-error" class="error-box hidden">
                        ‚ùå ÂêçÂçï‰∏çËÉΩ‰∏∫Á©∫
                    </div>
                    <div class="modal-actions">
                        <button id="cancel-settings-btn" class="secondary-btn">ÂèñÊ∂à</button>
                        <button id="apply-settings-btn" class="primary-btn">Â∫îÁî®ÂêçÂçï</button>
                    </div>
                </div>
            </div>

            <!-- Prize Config Modal -->
            <div id="prize-modal-overlay">
                <div id="prize-modal">
                    <h3>Â•ñÈ°πÈÖçÁΩÆ</h3>
                    <div id="prize-list">
                        <!-- Prize items -->
                    </div>
                    <button id="add-prize-btn" class="dashed-btn">+ Ê∑ªÂä†Â•ñÈ°π</button>
                    <div class="modal-actions">
                        <button id="close-prize-btn" class="primary-btn">ÂÆåÊàê</button>
                    </div>
                </div>
            </div>
		</div>

		<script>
			import { LotterySphere } from '../components/LotterySphere';
			import names from '../data/name';
            import { createPrize, validatePrizeList } from '../lib/prizeConfigState';
            import { drawWinners } from '../lib/drawEngine';
            import type { Prize } from '../lib/types';

			const canvas = document.getElementById('lottery-canvas') as HTMLCanvasElement;
			const startBtn = document.getElementById('start-btn') as HTMLButtonElement;
			const statusDisplay = document.getElementById('status-display') as HTMLDivElement;
			const modalOverlay = document.getElementById('modal-overlay') as HTMLDivElement;
            const modalTitle = document.getElementById('modal-title') as HTMLDivElement;
            const modalWinnersList = document.getElementById('modal-winners-list') as HTMLDivElement;
            const currentHighlight = document.getElementById('current-highlight') as HTMLDivElement;
			const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
            const winnersContainer = document.getElementById('winners-container') as HTMLDivElement;
            const clearResultsBtn = document.getElementById('clear-results-btn') as HTMLButtonElement;

            // Prize UI
            const prizeSelect = document.getElementById('prize-select') as HTMLSelectElement;
            const drawCountEl = document.getElementById('draw-count') as HTMLSpanElement;
            const prizesBtn = document.getElementById('prizes-btn') as HTMLButtonElement;
            const prizeModalOverlay = document.getElementById('prize-modal-overlay') as HTMLDivElement;
            const prizeListEl = document.getElementById('prize-list') as HTMLDivElement;
            const addPrizeBtn = document.getElementById('add-prize-btn') as HTMLButtonElement;
            const closePrizeBtn = document.getElementById('close-prize-btn') as HTMLButtonElement;

            // Settings Elements
            const settingsBtn = document.getElementById('settings-btn') as HTMLButtonElement;
            const settingsOverlay = document.getElementById('settings-modal-overlay') as HTMLDivElement;
            const cancelSettingsBtn = document.getElementById('cancel-settings-btn') as HTMLButtonElement;
            const applySettingsBtn = document.getElementById('apply-settings-btn') as HTMLButtonElement;
            const namesInput = document.getElementById('names-input') as HTMLTextAreaElement;
            const validCountEl = document.getElementById('valid-count') as HTMLElement;
            const rawCountEl = document.getElementById('raw-count') as HTMLElement;
            const dupWarningEl = document.getElementById('duplicate-warning') as HTMLDivElement;
            const dupListEl = document.getElementById('dup-list') as HTMLElement;
            const emptyErrorEl = document.getElementById('empty-error') as HTMLDivElement;
			
			let sphere: LotterySphere | null = null;
			let isLotteryRunning = false;
            
            // State
            let currentNamesList = [...names]; // Candidates pool
            let prizes: Prize[] = [
                createPrize('‰∏ÄÁ≠âÂ•ñ', 1, 'Â§ßÂ•ñ'),
                createPrize('‰∫åÁ≠âÂ•ñ', 2),
                createPrize('‰∏âÁ≠âÂ•ñ', 5)
            ];
            let results: Record<string, string[]> = {};
            let currentPrizeId = prizes[0].id;

			if (canvas) {
				sphere = new LotterySphere(canvas, currentNamesList);
			}
            
            window.addEventListener('beforeunload', () => {
                if (sphere) sphere.destroy();
            });

			function updateStatus(text: string) {
				if (statusDisplay) statusDisplay.textContent = text;
			}
            
            // --- Prize Logic ---
            
            function renderPrizeOptions() {
                if (!prizeSelect) return;
                prizeSelect.innerHTML = '';
                prizes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.title;
                    prizeSelect.appendChild(option);
                });
                prizeSelect.value = currentPrizeId;
                updateCurrentPrizeInfo();
            }

            function updateCurrentPrizeInfo() {
                const p = prizes.find(x => x.id === currentPrizeId);
                if (p && drawCountEl) {
                    drawCountEl.textContent = p.count.toString();
                }
            }
            
            prizeSelect?.addEventListener('change', (e) => {
                currentPrizeId = (e.target as HTMLSelectElement).value;
                updateCurrentPrizeInfo();
            });

            // Prize Configuration Modal Logic
            function renderPrizeConfigList() {
                if (!prizeListEl) return;
                prizeListEl.innerHTML = '';
                prizes.forEach((p, index) => {
                    const row = document.createElement('div');
                    row.className = 'prize-config-row';
                    row.innerHTML = `
                        <input type="text" class="prize-title-input" value="${p.title}" placeholder="Â•ñÈ°πÂêçÁß∞">
                        <input type="number" class="prize-count-input" value="${p.count}" min="1" placeholder="‰∫∫Êï∞">
                        <button class="delete-prize-btn" data-id="${p.id}">üóëÔ∏è</button>
                    `;
                    
                    const titleInput = row.querySelector('.prize-title-input') as HTMLInputElement;
                    const countInput = row.querySelector('.prize-count-input') as HTMLInputElement;
                    const delBtn = row.querySelector('.delete-prize-btn') as HTMLButtonElement;
                    
                    titleInput.addEventListener('change', () => {
                        p.title = titleInput.value;
                        renderPrizeOptions(); // Live update dropdown
                    });
                    
                    countInput.addEventListener('change', () => {
                        let val = parseInt(countInput.value);
                        if (val < 1) val = 1;
                        p.count = val;
                        updateCurrentPrizeInfo();
                    });
                    
                    delBtn.addEventListener('click', () => {
                        if (prizes.length <= 1) {
                            alert('Ëá≥Â∞ë‰øùÁïô‰∏Ä‰∏™Â•ñÈ°π');
                            return;
                        }
                        prizes = prizes.filter(x => x.id !== p.id);
                        if (currentPrizeId === p.id) currentPrizeId = prizes[0].id;
                        renderPrizeConfigList();
                        renderPrizeOptions();
                    });
                    
                    prizeListEl.appendChild(row);
                });
            }

            prizesBtn?.addEventListener('click', () => {
                prizeModalOverlay.classList.add('visible');
                renderPrizeConfigList();
            });

            addPrizeBtn?.addEventListener('click', () => {
                prizes.push(createPrize(`Êñ∞Â•ñÈ°π ${prizes.length + 1}`, 1));
                renderPrizeConfigList();
                renderPrizeOptions();
            });

            closePrizeBtn?.addEventListener('click', () => {
                // Validate
                const error = validatePrizeList(prizes);
                if (error) {
                    alert(error);
                    return;
                }
                prizeModalOverlay.classList.remove('visible');
            });

            // --- Results Logic ---

            function renderResultsPanel() {
                if (!winnersContainer) return;
                winnersContainer.innerHTML = '';
                
                prizes.forEach(p => {
                    const winners = results[p.id] || [];
                    if (winners.length === 0) return;
                    
                    const group = document.createElement('div');
                    group.className = 'winner-group';
                    group.innerHTML = `<h4>${p.title}</h4>`;
                    
                    const list = document.createElement('div');
                    list.className = 'winner-group-list';
                    list.textContent = winners.join('„ÄÅ');
                    group.appendChild(list);
                    
                    winnersContainer.appendChild(group);
                });
            }
            
            clearResultsBtn?.addEventListener('click', () => {
                if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâ‰∏≠Â•ñËÆ∞ÂΩïÂπ∂ÈáçÁΩÆÂêçÂçïÂêóÔºü')) {
                    results = {};
                    renderResultsPanel();
                    // Restore names
                    const namesToRestore = processInput(); // Get from textarea
                    currentNamesList = namesToRestore;
                    sphere?.setNames(currentNamesList);
                    updateStatus('Â∑≤ÈáçÁΩÆ');
                    startBtn.disabled = false;
                }
            });

            // --- Main Flow ---

            // Initial render
            renderPrizeOptions();

            startBtn?.addEventListener('click', () => {
                if (isLotteryRunning) return;
                
                const prize = prizes.find(p => p.id === currentPrizeId);
                if (!prize) return;
                
                if (currentNamesList.length < prize.count) {
                    alert(`Ââ©‰Ωô‰∫∫Êï∞‰∏çË∂≥ÔºÅÂΩìÂâçÂâ©‰Ωô ${currentNamesList.length} ‰∫∫ÔºåÈúÄË¶Å ${prize.count} ‰∫∫„ÄÇ`);
                    return;
                }
                
                isLotteryRunning = true;
                startBtn.disabled = true;
                settingsBtn.disabled = true;
                prizesBtn.disabled = true;
                prizeSelect.disabled = true;
                updateStatus(`Ê≠£Âú®ÊäΩÂèñ ${prize.title}...`);
                
                // 1. Start spinning
                sphere?.spin();
                
                // 2. Draw winners logic (simulate delay or do it immediately)
                // Let's do it immediately but wait a bit before stopping
                const { winners, remainingCandidates } = drawWinners(currentNamesList, prize.count);
                
                // Update state
                currentNamesList = remainingCandidates;
                if (!results[prize.id]) results[prize.id] = [];
                results[prize.id].push(...winners);
                
                // 3. Stop after 2 seconds
                setTimeout(() => {
                    // Update sphere logic to stop and highlight
                    sphere?.stopAndHighlightWinners(
                        winners, 
                        (name) => {
                            // On highlight one winner
                            if (currentHighlight) {
                                currentHighlight.textContent = name;
                                currentHighlight.classList.remove('pop');
                                void currentHighlight.offsetWidth; // trigger reflow
                                currentHighlight.classList.add('pop');
                            }
                        },
                        () => {
                            // On all finished
                            isLotteryRunning = false;
                            updateStatus('ÊäΩÂ•ñÂÆåÊàê');
                            
                            // Show modal
                            modalOverlay.classList.add('visible');
                            if (modalTitle) modalTitle.textContent = `${prize.title} ÁªìÊûú`;
                            if (modalWinnersList) {
                                modalWinnersList.innerHTML = winners.map(w => `<span class="badge">${w}</span>`).join('');
                            }
                            if (currentHighlight) currentHighlight.textContent = ''; // Clear highlight text
                            
                            // Render sidebar results
                            renderResultsPanel();
                            
                            // Remove winners from sphere visuals
                            winners.forEach(w => sphere?.removeWinner(w));
                        }
                    );
                }, 2000);
            });

            nextBtn?.addEventListener('click', () => {
                modalOverlay.classList.remove('visible');
                updateStatus('ÂáÜÂ§áÂ∞±Áª™');
                
                if (currentNamesList.length === 0) {
                    startBtn.disabled = true;
                    updateStatus('ÊâÄÊúâÂêçÂçïÂ∑≤ÊäΩÂÆå');
                } else {
                    startBtn.disabled = false;
                }
                
                settingsBtn.disabled = false;
                prizesBtn.disabled = false;
                prizeSelect.disabled = false;
            });

            // --- Existing Settings Logic (Process Input) ---
            // (Kept mostly same, just added return type to processInput used above)
            
            function processInput() {
                if (!namesInput) return [];
                const rawText = namesInput.value;
                const lines = rawText.split('\n');
                
                const validNames: string[] = [];
                const duplicates: string[] = [];
                const seen = new Set<string>();
                
                lines.forEach(line => {
                    const clean = line.trim().replace(/\s+/g, ' ');
                    if (!clean) return;
                    
                    if (seen.has(clean)) {
                        duplicates.push(clean);
                    } else {
                        seen.add(clean);
                        validNames.push(clean);
                    }
                });
                
                // Update UI (Counts)
                if (rawCountEl) rawCountEl.textContent = lines.length.toString();
                if (validCountEl) validCountEl.textContent = validNames.length.toString();
                
                // Duplicates
                if (duplicates.length > 0) {
                    dupWarningEl?.classList.remove('hidden');
                    const top10 = duplicates.slice(0, 10);
                    let msg = top10.join(', ');
                    if (duplicates.length > 10) msg += ' Á≠â';
                    if (dupListEl) dupListEl.textContent = msg;
                } else {
                    dupWarningEl?.classList.add('hidden');
                }
                
                // Empty check
                if (validNames.length === 0) {
                    emptyErrorEl?.classList.remove('hidden');
                    if (applySettingsBtn) applySettingsBtn.disabled = true;
                } else {
                    emptyErrorEl?.classList.add('hidden');
                    if (applySettingsBtn) applySettingsBtn.disabled = false;
                }
                
                return validNames;
            }

            // Settings Event Listeners
            settingsBtn?.addEventListener('click', () => {
                settingsOverlay.classList.add('visible');
                // If we have current names, we might want to sync back to textarea if it was empty?
                // But usually we trust the textarea content as the source of truth for "Reset".
                // If textarea is empty, maybe fill it?
                if (namesInput && !namesInput.value && currentNamesList.length > 0) {
                    namesInput.value = currentNamesList.join('\n');
                }
                processInput();
            });

            cancelSettingsBtn?.addEventListener('click', () => {
                settingsOverlay.classList.remove('visible');
            });

            namesInput?.addEventListener('input', processInput);

            applySettingsBtn?.addEventListener('click', () => {
                const newNames = processInput();
                if (newNames.length === 0) return;
                
                if (confirm('Â∫îÁî®Êñ∞ÂêçÂçïÂ∞ÜÊ∏ÖÁ©∫ÂΩìÂâç‰∏≠Â•ñËÆ∞ÂΩïÔºåÁ°ÆÂÆöÂêóÔºü')) {
                    currentNamesList = newNames;
                    results = {};
                    renderResultsPanel();
                    sphere?.setNames(newNames);
                    
                    startBtn.disabled = false;
                    updateStatus('ÂáÜÂ§áÂ∞±Áª™');
                    settingsOverlay.classList.remove('visible');
                }
            });
		</script>
	</body>
</html>
