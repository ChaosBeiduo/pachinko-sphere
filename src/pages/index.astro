---
import '../styles/global.scss'
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Pachinko Sphere</title>
		<style is:global>
			#sphere-container {
				width: 100vw;
				height: 100vh;
                height: 100dvh;
				position: relative;
			}
			canvas {
				display: block;
				width: 100%;
				height: 100%;
			}
			
			/* UI Overlay */
			#ui-layer {
				position: absolute;
				bottom: 40px;
				left: 50%;
				transform: translateX(-50%);
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 20px;
				z-index: 10;
				pointer-events: none;
			}
            
            .control-panel {
                background: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                padding: 20px 40px;
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                pointer-events: auto;
            }

            .prize-selector {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 10px;
            }

            #prize-select {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                font-size: 1rem;
                outline: none;
                cursor: pointer;
            }

            #prize-select option {
                background: #222;
                color: white;
            }

            .prize-info {
                font-size: 0.9rem;
                color: #ccc;
            }

            #draw-count {
                color: #ff3366;
                font-weight: bold;
                font-size: 1.1rem;
            }

            .free-selector {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }

            .free-info {
                font-size: 1rem;
                color: #ff3366;
                font-weight: bold;
            }

            .free-actions {
                display: flex;
                gap: 10px;
            }

            .dashed-btn.sm {
                padding: 4px 10px;
                font-size: 0.8rem;
            }

            .empty-results {
                color: rgba(255, 255, 255, 0.4);
                text-align: center;
                padding: 20px 0;
                font-style: italic;
            }

            .winner-group-list.free-results-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: flex-start;
                line-height: 1.6;
            }
			
			#status-display {
				font-size: 1.5rem;
				font-weight: bold;
				text-shadow: 0 2px 4px rgba(0,0,0,0.8);
				min-height: 2rem;
			}

            /* Winners Panel */
            #winners-panel {
                position: absolute;
                top: 80px;
                right: 20px;
                width: 260px;
                max-height: calc(100vh - 100px);
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                border-radius: 12px;
                padding: 15px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: column;
                pointer-events: auto;
                z-index: 5;
            }
            
            #winners-panel h3 {
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding-bottom: 10px;
                color: #fff;
            }
            
            #winners-container {
                flex: 1;
                overflow-y: auto;
                margin-bottom: 15px;
            }
            
            .winner-group {
                margin-bottom: 15px;
            }
            
            .winner-group h4 {
                margin: 0 0 5px 0;
                font-size: 0.9rem;
                color: #aaa;
                text-transform: uppercase;
            }
            
            .winner-group-list {
                color: #ffd700;
                font-size: 0.95rem;
                line-height: 1.4;
                word-break: break-all;
            }

            /* Result Modal Overlay */
            #modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(3px);
                z-index: 100;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                visibility: hidden; /* Ensure hidden when not visible */
                pointer-events: none;
                transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            }
            
            #modal-overlay.visible {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                transition: opacity 0.3s ease, visibility 0s linear 0s;
            }

			#result-modal {
				background: rgba(20, 20, 20, 0.95);
				padding: 50px 80px;
				border-radius: 20px;
				border: 1px solid rgba(255, 255, 255, 0.2);
				text-align: center;
				box-shadow: 0 0 50px rgba(0,0,0,0.5);
				transform: scale(0.9);
				transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			}
			
            #modal-overlay.visible #result-modal {
                transform: scale(1);
            }
			
			.winner-title {
				font-size: 1.5rem;
				color: #fff;
				margin-bottom: 20px;
				text-transform: uppercase;
				letter-spacing: 2px;
			}
			
			.winner-name {
				font-size: 4rem;
				font-weight: 800;
				background: linear-gradient(45deg, #ffd700, #ffaa00, #ffea00);
                background-size: 200% auto;
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				margin: 0;
                animation: shine 3s linear infinite;
			}
            
            @keyframes shine {
                to {
                    background-position: 200% center;
                }
            }

            /* Result Modal Badges */
            #modal-winners-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
                margin: 30px 0;
            }

            .badge {
                background: rgba(255, 215, 0, 0.2);
                border: 1px solid rgba(255, 215, 0, 0.5);
                color: #ffd700;
                padding: 10px 20px;
                border-radius: 50px;
                font-size: 1.5rem;
                font-weight: bold;
                animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            @keyframes popIn {
                from { transform: scale(0); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }

            .highlight-name {
                font-size: 3rem;
                color: #fff;
                font-weight: bold;
                height: 4rem;
                margin-bottom: 20px;
                text-shadow: 0 0 20px rgba(255, 51, 102, 0.8);
            }

            .highlight-name.pop {
                animation: popScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            @keyframes popScale {
                0% { transform: scale(1); }
                50% { transform: scale(1.5); }
                100% { transform: scale(1); }
            }

            /* Prize Config Modal */
            #prize-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 200;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            }

            #prize-modal-overlay.visible {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                transition: opacity 0.3s ease, visibility 0s linear 0s;
            }

            #prize-modal {
                background: #1a1a1a;
                width: 500px;
                max-width: 90%;
                border-radius: 12px;
                padding: 30px;
                border: 1px solid #333;
                display: flex;
                flex-direction: column;
                gap: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            }

            #prize-modal h3 {
                margin: 0;
                color: #fff;
            }

            #prize-list {
                max-height: 300px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .prize-config-row {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .prize-title-input {
                flex: 2;
                background: #222;
                border: 1px solid #444;
                color: white;
                padding: 8px;
                border-radius: 4px;
            }

            .prize-count-input {
                flex: 1;
                background: #222;
                border: 1px solid #444;
                color: white;
                padding: 8px;
                border-radius: 4px;
            }

            .delete-prize-btn {
                background: transparent;
                border: none;
                cursor: pointer;
                font-size: 1.2rem;
                padding: 5px;
                transition: transform 0.2s;
            }

            .delete-prize-btn:hover {
                transform: scale(1.1);
            }

            .dashed-btn {
                background: transparent;
                border: 2px dashed #444;
                color: #888;
                transition: all 0.2s;
                text-transform: none;
                letter-spacing: normal;
            }

            .dashed-btn:hover {
                border-color: #666;
                color: #aaa;
                background: rgba(255, 255, 255, 0.05);
                transform: none;
                box-shadow: none;
            }

            .small {
                padding: 5px 15px;
                font-size: 0.8rem;
                border-radius: 6px;
                text-transform: none;
                letter-spacing: normal;
            }

            /* Settings Button (Top Right) */
            #top-bar {
                position: absolute;
                top: 20px;
                left: 20px;
                right: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                z-index: 100;
            }

            #mode-toggle-container {
                display: flex;
                background: rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                padding: 4px;
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .mode-btn {
                padding: 6px 16px;
                border-radius: 8px;
                border: none;
                background: transparent;
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.3s;
            }

            .mode-btn.active {
                background: rgba(255, 255, 255, 0.15);
                color: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            }

            .mode-btn:hover:not(.active) {
                color: white;
            }

            #system-config-btn {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                padding: 10px 20px;
                border-radius: 30px;
                color: white;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            #system-config-btn:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateY(-2px);
            }

            /* Unified System Modal */
            #system-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                z-index: 200;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            }
            #system-modal-overlay.visible {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                transition: opacity 0.3s ease, visibility 0s linear 0s;
            }
            #system-modal {
                background: rgba(30, 30, 30, 0.8);
                backdrop-filter: blur(20px);
                width: 700px;
                max-width: 90%;
                border-radius: 16px;
                padding: 0;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                max-height: 85vh;
            }
            
            .modal-header {
                padding: 20px 30px;
                background: rgba(0,0,0,0.2);
                border-bottom: 1px solid rgba(255,255,255,0.05);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-tabs {
                display: flex;
                gap: 20px;
            }
            
            .tab-btn {
                background: transparent;
                border: none;
                color: #888;
                font-size: 1rem;
                font-weight: bold;
                padding: 10px 5px;
                cursor: pointer;
                position: relative;
                box-shadow: none;
                transform: none;
                transition: color 0.2s;
                border-radius: 0;
            }
            
            .tab-btn:hover {
                color: #ccc;
                background: transparent;
                transform: none;
                box-shadow: none;
            }
            
            .tab-btn.active {
                color: #fff;
            }
            
            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: -21px; /* Adjust to align with header bottom */
                left: 0;
                width: 100%;
                height: 3px;
                background: #ff3366;
                box-shadow: 0 -2px 10px rgba(255, 51, 102, 0.5);
            }
            
            .close-modal-btn {
                background: transparent;
                border: none;
                color: #666;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0;
                line-height: 1;
                box-shadow: none;
            }
            .close-modal-btn:hover {
                color: #fff;
                background: transparent;
                transform: none;
                box-shadow: none;
            }

            .modal-body {
                padding: 30px;
                overflow-y: auto;
                flex: 1;
            }
            
            .tab-content {
                display: none;
                animation: fadeIn 0.3s ease;
            }
            .tab-content.active {
                display: block;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* Inputs & Forms */
            .input-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                color: #aaa;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }
            
            textarea, input[type="text"], input[type="number"] {
                width: 100%;
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #fff;
                padding: 12px;
                border-radius: 8px;
                font-family: inherit;
                font-size: 1rem;
                box-sizing: border-box;
                transition: border-color 0.2s;
            }
            
            textarea:focus, input:focus {
                outline: none;
                border-color: #ff3366;
                background: rgba(0, 0, 0, 0.5);
            }

            /* Prize List Styling */
            .prize-config-row {
                display: flex;
                gap: 15px;
                align-items: center;
                background: rgba(255, 255, 255, 0.03);
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 10px;
                border: 1px solid transparent;
                transition: border-color 0.2s;
            }
            .prize-config-row:hover {
                border-color: rgba(255, 255, 255, 0.1);
            }

            /* Language Switcher */
            .lang-switcher {
                margin-left: auto;
                margin-right: 20px;
            }
            .lang-select {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #ccc;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 0.9rem;
                cursor: pointer;
                outline: none;
            }
            .lang-select option {
                background: #333;
                color: white;
            }

            /* Welcome Modal */
            #welcome-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(10px);
                z-index: 300;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                transition: opacity 0.5s ease, visibility 0s linear 0.5s;
            }
            
            #welcome-modal-overlay.visible {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                transition: opacity 0.5s ease, visibility 0s linear 0s;
            }

            #welcome-modal {
                background: rgba(30, 30, 30, 0.6);
                padding: 50px 60px;
                border-radius: 24px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                text-align: center;
                box-shadow: 0 20px 60px rgba(0,0,0,0.6);
                max-width: 90%;
                width: 500px;
                transform: translateY(20px);
                transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            }

            #welcome-modal-overlay.visible #welcome-modal {
                transform: translateY(0);
            }

            .welcome-title {
                font-size: 2rem;
                margin: 0 0 10px 0;
                background: linear-gradient(135deg, #fff, #aaa);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .welcome-subtitle {
                color: #888;
                margin-bottom: 40px;
                font-size: 1.1rem;
            }

            .language-options {
                display: flex;
                gap: 20px;
                justify-content: center;
                margin-bottom: 30px;
            }

            .lang-option-btn {
                flex: 1;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }

            .lang-option-btn:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.3);
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            }

            .lang-option-btn.selected {
                border-color: #ff3366;
                background: rgba(255, 51, 102, 0.1);
            }

            .lang-name {
                font-size: 1.5rem;
                font-weight: bold;
                color: #fff;
            }

            .lang-desc {
                font-size: 0.9rem;
                color: #aaa;
            }

            .welcome-note {
                font-size: 0.9rem;
                color: #666;
                line-height: 1.6;
                margin: 0;
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.05);
            }

            /* Mobile Adaptation */
            @media (max-width: 768px) {
                /* Layout Adjustments */
                #ui-layer {
                    bottom: calc(16px + env(safe-area-inset-bottom));
                    width: calc(100% - 24px);
                    gap: 15px;
                }
                
                .control-panel {
                    width: 100%;
                    padding: 14px 14px;
                    box-sizing: border-box;
                }

                #top-bar {
                    top: calc(10px + env(safe-area-inset-top));
                    left: 12px;
                    right: 12px;
                    gap: 8px;
                    flex-wrap: wrap;
                }

                #mode-toggle-container {
                    width: 100%;
                    order: 2;
                }
                
                .mode-btn {
                    flex: 1;
                    text-align: center;
                    padding: 8px 10px;
                }

                #system-config-btn {
                    order: 1;
                    margin-left: auto;
                    padding: 8px 12px;
                    font-size: 0.8rem;
                }

                /* Winners Panel Compact Mode */
                #winners-panel {
                    top: auto;
                    right: 12px;
                    left: 12px;
                    bottom: calc(200px + env(safe-area-inset-bottom));
                    width: auto;
                    padding: 10px;
                    max-height: 25vh;
                }
                
                #winners-panel h3 {
                    font-size: 0.9rem;
                    margin-bottom: 8px;
                }
                
                .winner-group h4 {
                    font-size: 0.8rem;
                }
                
                .winner-group-list {
                    font-size: 0.8rem;
                }

                #winners-container {
                    margin-bottom: 10px;
                }

                .prize-selector {
                    width: 100%;
                    flex-direction: column;
                    align-items: stretch;
                    gap: 8px;
                    margin-bottom: 6px;
                }

                #prize-select {
                    width: 100%;
                }

                .prize-info {
                    text-align: center;
                }

                .free-actions {
                    flex-wrap: wrap;
                    justify-content: center;
                }

                .stats-bar {
                    flex-wrap: wrap;
                    gap: 10px;
                }
                
                .stats-bar > div {
                    width: 100%;
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    justify-content: flex-end;
                }

                /* Modals Mobile Style */
                #result-modal, 
                #welcome-modal {
                    padding: 24px 16px;
                    width: calc(100% - 24px);
                    max-height: 85vh;
                    overflow-y: auto;
                }

                .winner-name {
                    font-size: 2.5rem;
                }

                #modal-winners-list {
                    gap: 10px;
                    margin: 20px 0;
                }

                .badge {
                    font-size: 1rem;
                    padding: 8px 14px;
                }

                .highlight-name {
                    font-size: 1.5rem;
                    height: 2.2rem;
                    margin-bottom: 12px;
                }

                #system-modal {
                    width: calc(100% - 16px);
                    height: 92dvh;
                    max-height: 92dvh;
                }

                .modal-header {
                    padding: 12px;
                    flex-wrap: wrap;
                    gap: 10px;
                }

                .modal-tabs {
                    gap: 6px;
                    width: 100%;
                    overflow-x: auto;
                    scrollbar-width: none;
                }

                .modal-tabs::-webkit-scrollbar {
                    display: none;
                }

                .tab-btn {
                    white-space: nowrap;
                    font-size: 0.9rem;
                    padding: 8px 6px;
                }
                
                .lang-switcher {
                    margin-left: 0;
                    margin-right: 0;
                }
                
                .modal-body {
                    padding: 15px;
                }

                /* Buttons & Inputs */
                button, .primary-btn, .dashed-btn {
                    padding: 10px 14px;
                    font-size: 0.9rem;
                }

                #start-btn {
                    width: 100%;
                    padding: 12px 0;
                }

                #status-display {
                    font-size: 1.1rem;
                    min-height: 1.5rem;
                }

                .language-options {
                    flex-direction: column;
                    gap: 10px;
                }

                .lang-option-btn {
                    padding: 15px;
                    flex-direction: row;
                    justify-content: center;
                }

                .prize-config-row {
                    gap: 8px;
                }
                
                .prize-title-input {
                    min-width: 0;
                }
                
                .delete-prize-btn {
                    padding: 8px;
                }
            }

            @media (max-width: 480px) {
                #winners-panel {
                    bottom: calc(210px + env(safe-area-inset-bottom));
                    max-height: 22vh;
                }

                .control-panel {
                    padding: 12px;
                    gap: 10px;
                }

                #system-config-btn {
                    font-size: 0.75rem;
                    padding: 7px 10px;
                }

                .mode-btn {
                    font-size: 0.8rem;
                    padding: 7px 8px;
                }

                .dashed-btn.sm {
                    font-size: 0.75rem;
                    padding: 5px 8px;
                }
            }
		</style>
	</head>
	<body>
		<div id="sphere-container">
            <div id="top-bar">
                <div id="mode-toggle-container">
                    <button id="mode-prize" class="mode-btn active" data-mode="prize" data-i18n="prizeMode">Â•ñÈ°πÊ®°Âºè</button>
                    <button id="mode-free" class="mode-btn" data-mode="free" data-i18n="freeMode">Ëá™Áî±Ê®°Âºè</button>
                </div>
                <button id="system-config-btn" data-i18n="systemConfig">‚öôÔ∏è Á≥ªÁªüÈÖçÁΩÆ</button>
            </div>
			<canvas id="lottery-canvas"></canvas>
			
			<div id="ui-layer">
                <div class="control-panel">
                    <div id="prize-mode-controls" class="prize-selector">
                        <select id="prize-select">
                            <!-- Prizes will be populated here -->
                        </select>
                        <div class="prize-info">
                            <span data-i18n="drawing">Êú¨Ê¨°ÊäΩÂèñ</span> <span id="draw-count">0</span> <span data-i18n="people">‰∫∫</span>
                        </div>
                    </div>
                    
                    <div id="free-mode-controls" class="free-selector" style="display: none;">
                        <div class="free-info">
                            <span id="free-draw-count-label">Â∑≤ÊäΩ‰∫∫Êï∞: 0</span>
                        </div>
                        <div class="free-actions">
                            <button id="undo-btn" class="dashed-btn sm" data-i18n="undoLast">Êí§ÈîÄ‰∏ä‰∏Ä‰∏™</button>
                            <button id="reset-free-btn" class="dashed-btn sm" data-i18n="resetRound">ÈáçÁΩÆÊú¨ËΩÆ</button>
                        </div>
                    </div>

                    <div id="status-display" data-i18n="ready">ÂáÜÂ§áÂ∞±Áª™</div>
                    <button id="start-btn" data-i18n="startLottery">ÂºÄÂßãÊäΩÂ•ñ</button>
                </div>
			</div>
            
            <div id="winners-panel">
                <h3 data-i18n="lotteryResults">‰∏≠Â•ñÁªìÊûú</h3>
                <div id="winners-container">
                    <!-- Results grouped by prize -->
                </div>
                <button id="clear-results-btn" class="secondary-btn small" data-i18n="clearResults">Ê∏ÖÁ©∫ÁªìÊûú</button>
            </div>
			
            <div id="modal-overlay">
                <div id="result-modal">
                    <div class="winner-title" id="modal-title" data-i18n="congrats">üéâ ÊÅ≠Âñú üéâ</div>
                    <div id="modal-winners-list">
                        <!-- Winners shown here -->
                    </div>
                    <div id="current-highlight" class="highlight-name"></div>
                    <button class="next-btn" id="next-btn" data-i18n="nextRound">‰∏ã‰∏ÄËΩÆ</button>
                </div>
            </div>

            <!-- Unified System Modal -->
            <div id="system-modal-overlay">
                <div id="system-modal">
                    <div class="modal-header">
                        <div class="modal-tabs">
                            <button class="tab-btn active" data-tab="names" data-i18n="nameSettings">ÂêçÂçïËÆæÁΩÆ</button>
                            <button class="tab-btn" data-tab="prizes" data-i18n="prizeSettings">Â•ñÈ°πÈÖçÁΩÆ</button>
                            <button class="tab-btn" data-tab="animation" data-i18n="animationSettings">Âä®ÁîªËÆæÁΩÆ</button>
                        </div>
                        <div class="lang-switcher">
                            <select id="lang-select" class="lang-select">
                                <option value="zh">‰∏≠Êñá</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <button class="close-modal-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Names Tab -->
                        <div id="tab-names" class="tab-content active">
                            <div class="input-group">
                                <label data-i18n="candidateList">ÂÄôÈÄâÂêçÂçïÔºàÊØèË°å‰∏Ä‰∏™ÂêçÂ≠óÔºâ</label>
                                <textarea id="names-input" placeholder="ËØ∑ËæìÂÖ•ÊàñÁ≤òË¥¥ÂßìÂêçÔºåÊØèË°å‰∏Ä‰∏™..." rows="15"></textarea>
                            </div>
                            <div class="stats-bar" style="display: flex; justify-content: space-between; align-items: center; color: #888;">
                                <span><span data-i18n="imported">Â∑≤ÂØºÂÖ•:</span> <strong id="valid-count" style="color: #fff">0</strong> <span data-i18n="people">‰∫∫</span></span>
                                <div style="display: flex; gap: 10px;">
                                    <button id="import-file-btn" class="dashed-btn" data-i18n="importFile">üìÇ ÂØºÂÖ•Êñá‰ª∂</button>
                                    <button id="import-blob-btn" class="dashed-btn" data-i18n="importBlob">üîê ‰ΩøÁî®ÂêçÂçï</button>
                                    <button id="save-names-btn" class="primary-btn" data-i18n="saveNames">‰øùÂ≠òÂêçÂçï</button>
                                </div>
                            </div>
                        </div>

                        <!-- Prizes Tab -->
                        <div id="tab-prizes" class="tab-content">
                            <div id="prize-list-config">
                                <!-- Prize rows will be generated here -->
                            </div>
                            <button id="add-prize-btn" class="dashed-btn" style="width: 100%; margin-top: 15px;" data-i18n="addPrize">+ Ê∑ªÂä†Êñ∞Â•ñÈ°π</button>
                        </div>

                        <!-- Animation Tab -->
                        <div id="tab-animation" class="tab-content">
                            <style>
                                .settings-row {
                                    display: flex;
                                    flex-direction: column;
                                    gap: 10px;
                                    margin-bottom: 25px;
                                    background: rgba(255, 255, 255, 0.03);
                                    padding: 15px;
                                    border-radius: 8px;
                                }
                                .settings-row-header {
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                }
                                .settings-row-header label {
                                    margin-bottom: 0;
                                }
                                .settings-input-container {
                                    display: flex;
                                    align-items: center;
                                    gap: 15px;
                                }
                                .settings-slider {
                                    flex: 1;
                                    accent-color: #ff3366;
                                }
                                .settings-num-input {
                                    width: 80px !important;
                                    text-align: center;
                                }
                            </style>
                            
                            <div class="settings-row">
                                <div class="settings-row-header">
                                    <label data-i18n="rotationSpeed">Âü∫Á°ÄÊóãËΩ¨ÈÄüÂ∫¶ (rad/s)</label>
                                </div>
                                <div class="settings-input-container">
                                    <input type="range" id="speed-slider" class="settings-slider" min="0.1" max="5" step="0.1">
                                    <input type="number" id="speed-input" class="settings-num-input" min="0.1" max="5" step="0.1">
                                </div>
                            </div>

                            <div class="settings-row">
                                <div class="settings-row-header">
                                    <label data-i18n="spinTurns">ÊäΩÂ•ñÊóãËΩ¨ÂúàÊï∞</label>
                                </div>
                                <div class="settings-input-container">
                                    <input type="range" id="turns-slider" class="settings-slider" min="1" max="50" step="1">
                                    <input type="number" id="turns-input" class="settings-num-input" min="1" max="50" step="1">
                                </div>
                            </div>

                            <div class="settings-row">
                                <div class="settings-row-header">
                                    <label data-i18n="spinDuration">ÊäΩÂ•ñÊåÅÁª≠Êó∂Èó¥ (Áßí)</label>
                                </div>
                                <div class="settings-input-container">
                            <input type="range" id="duration-slider" class="settings-slider" min="1" max="30" step="1">
                            <input type="number" id="duration-input" class="settings-num-input" min="1" max="30" step="1">
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-row-header">
                            <label data-i18n="extraRevs">ÂÅúÊ≠¢ÂâçÈ¢ùÂ§ñÊóãËΩ¨ (Âúà)</label>
                        </div>
                        <div class="settings-input-container">
                            <input type="range" id="extra-revs-slider" class="settings-slider" min="0" max="100" step="1">
                            <input type="number" id="extra-revs-input" class="settings-num-input" min="0" max="100" step="1">
                        </div>
                    </div>
                    <button id="restore-defaults-btn" class="dashed-btn" style="width: 100%; margin-top: 10px;" data-i18n="restoreDefault">ÊÅ¢Â§çÈªòËÆ§</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Welcome / Language Selection Modal -->
            <div id="welcome-modal-overlay">
                <div id="welcome-modal">
                    <h1 class="welcome-title">Welcome / Ê¨¢Ëøé</h1>
                    <p class="welcome-subtitle">Please select your language / ËØ∑ÈÄâÊã©ËØ≠Ë®Ä</p>
                    <div class="language-options">
                        <button class="lang-option-btn" data-lang="zh">
                            <span class="lang-name">‰∏≠Êñá</span>
                            <span class="lang-desc">Chinese</span>
                        </button>
                        <button class="lang-option-btn" data-lang="en">
                            <span class="lang-name">English</span>
                            <span class="lang-desc">Ëã±ËØ≠</span>
                        </button>
                    </div>
                    <p class="welcome-note">
                        You can change this later in settings.<br>
                        Á®çÂêéÂèØ‰ª•Âú®ËÆæÁΩÆ‰∏≠‰øÆÊîπ„ÄÇ
                    </p>
                </div>
            </div>
		</div>

		<script>
			import { LotterySphere } from '../components/LotterySphere';
            import { store } from '../lib/store';
            import { modalManager } from '../lib/modalManager';
            import { translations, type Language } from '../lib/i18n';
            import { createPrize } from '../lib/prizeConfigState';
            import { LotteryManager } from '../lib/lotteryManager';
            import { settingsStore } from '../lib/settingsStore';
            import type { SphereSettings } from '../lib/types';

			const canvas = document.getElementById('lottery-canvas') as HTMLCanvasElement;
			const startBtn = document.getElementById('start-btn') as HTMLButtonElement;
			const statusDisplay = document.getElementById('status-display') as HTMLDivElement;
            
            // System Modal Elements
            const systemConfigBtn = document.getElementById('system-config-btn') as HTMLButtonElement;
            const systemModalOverlay = document.getElementById('system-modal-overlay') as HTMLDivElement;
            const closeModalBtn = document.querySelector('.close-modal-btn') as HTMLButtonElement;
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const langSelect = document.getElementById('lang-select') as HTMLSelectElement;

            // Settings Elements (inside System Modal)
            const namesInput = document.getElementById('names-input') as HTMLTextAreaElement;
            const validCountEl = document.getElementById('valid-count') as HTMLElement;
            const saveNamesBtn = document.getElementById('save-names-btn') as HTMLButtonElement;
            const importFileBtn = document.getElementById('import-file-btn') as HTMLButtonElement;
            const importBlobBtn = document.getElementById('import-blob-btn') as HTMLButtonElement;

            // Prize Config Elements (inside System Modal)
            const prizeListConfigEl = document.getElementById('prize-list-config') as HTMLDivElement;
            const addPrizeBtn = document.getElementById('add-prize-btn') as HTMLButtonElement;

            // Animation Settings Elements
            const speedSlider = document.getElementById('speed-slider') as HTMLInputElement;
            const speedInput = document.getElementById('speed-input') as HTMLInputElement;
            const turnsSlider = document.getElementById('turns-slider') as HTMLInputElement;
            const turnsInput = document.getElementById('turns-input') as HTMLInputElement;
            const durationSlider = document.getElementById('duration-slider') as HTMLInputElement;
            const durationInput = document.getElementById('duration-input') as HTMLInputElement;
            const extraRevsSlider = document.getElementById('extra-revs-slider') as HTMLInputElement;
            const extraRevsInput = document.getElementById('extra-revs-input') as HTMLInputElement;
            const restoreDefaultsBtn = document.getElementById('restore-defaults-btn') as HTMLButtonElement;

            // Main UI Elements
            const prizeSelect = document.getElementById('prize-select') as HTMLSelectElement;
            const drawCountEl = document.getElementById('draw-count') as HTMLSpanElement;
            const winnersContainer = document.getElementById('winners-container') as HTMLDivElement;
            const clearResultsBtn = document.getElementById('clear-results-btn') as HTMLButtonElement;

            // Mode Switching Elements
            const modeBtns = document.querySelectorAll('.mode-btn');
            const prizeModeControls = document.getElementById('prize-mode-controls');
            const freeModeControls = document.getElementById('free-mode-controls');
            const freeDrawCountLabel = document.getElementById('free-draw-count-label');
            const undoBtn = document.getElementById('undo-btn');
            const resetFreeBtn = document.getElementById('reset-free-btn');

			// Result Modal Elements
            const resultModalOverlay = document.getElementById('modal-overlay') as HTMLDivElement;
            const modalTitle = document.getElementById('modal-title') as HTMLDivElement;
            const modalWinnersList = document.getElementById('modal-winners-list') as HTMLDivElement;
            const currentHighlight = document.getElementById('current-highlight') as HTMLDivElement;
			const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
			
			let sphere: LotterySphere | null = null;

            // Initialize Lottery Manager to decouple logic from UI
            const lotteryManager = new LotteryManager({
                sphere: null, // Will be set after sphere is initialized
                onDrawStart: (prizeTitle) => {
                    updateStatus(t('drawingStatus', { prize: prizeTitle }));
                },
                onDrawComplete: (prizeTitle, winners) => {
                    updateStatus(t('drawComplete'));
                    
                    // Show result modal with animation
                    resultModalOverlay.classList.add('visible');
                    if (modalTitle) modalTitle.textContent = t('prizeResult', { prize: prizeTitle });
                    if (modalWinnersList) {
                        modalWinnersList.innerHTML = winners.map((w: string) => `<span class="badge">${w}</span>`).join('');
                    }
                    if (currentHighlight) currentHighlight.textContent = '';
                    
                    renderResultsPanel();
                },
                onWinnerHighlight: (name) => {
                    if (currentHighlight) {
                        currentHighlight.textContent = name;
                        currentHighlight.classList.remove('pop');
                        void currentHighlight.offsetWidth;
                        currentHighlight.classList.add('pop');
                    }
                }
            });
            
            function t(key: keyof typeof translations['zh'], params: Record<string, string | number> = {}) {
                const state = store.getState();
                // @ts-ignore
                let text = translations[state.language][key] || key;
                Object.entries(params).forEach(([k, v]) => {
                    text = text.replace(`{${k}}`, String(v));
                });
                return text;
            }

            function updateLanguage(lang: Language) {
                const state = store.getState();
                
                // Update simple elements
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n') as keyof typeof translations['zh'];
                    if (key && translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });

                // Update inputs placeholders
                if (namesInput) namesInput.placeholder = t('candidatePlaceholder');
                
                // Re-render prize config to update placeholders
                renderPrizeConfigList();
                
                // Update status if idle
                if (!state.isDrawing && statusDisplay) {
                    updateStatus(t('ready'));
                }

                if (freeDrawCountLabel) {
                    freeDrawCountLabel.textContent = t('drawCount', { count: state.freeResults.length });
                }
            }

            // Sync UI with Store
            function syncWithStore() {
                const state = store.getState();
                
                // Update Candidates in Sphere
                if (sphere) {
                    sphere.setNames(state.candidates);
                }

                // Update UI elements
                renderPrizeOptions();
                renderResultsPanel();
                updateCurrentPrizeInfo();
                updateLanguage(state.language);
                updateAnimationSettingsUI();
                
                // Update Name Input if empty
                if (namesInput && !namesInput.value && state.candidates.length > 0) {
                    namesInput.value = state.candidates.join('\n');
                    processInput();
                }

                // Update Drawing State
                startBtn.disabled = state.isDrawing;
                systemConfigBtn.disabled = state.isDrawing;
                prizeSelect.disabled = state.isDrawing;
                if (importBlobBtn) importBlobBtn.disabled = state.isDrawing;

                // Update Mode UI
                modeBtns.forEach(btn => {
                    const mode = (btn as HTMLElement).dataset.mode;
                    btn.classList.toggle('active', mode === state.mode);
                    (btn as HTMLButtonElement).disabled = state.isDrawing;
                });

                if (prizeModeControls) prizeModeControls.style.display = state.mode === 'prize' ? 'flex' : 'none';
                if (freeModeControls) freeModeControls.style.display = state.mode === 'free' ? 'flex' : 'none';
                
                if (freeDrawCountLabel) {
                    freeDrawCountLabel.textContent = t('drawCount', { count: state.freeResults.length });
                }
            }

            if (langSelect) {
                langSelect.value = store.getState().language;
                langSelect.addEventListener('change', (e) => {
                    const newLang = (e.target as HTMLSelectElement).value as Language;
                    store.setLanguage(newLang);
                });
            }

            // --- Welcome Modal Logic ---
            const welcomeModalOverlay = document.getElementById('welcome-modal-overlay');
            const langOptionBtns = document.querySelectorAll('.lang-option-btn');

            function checkFirstVisit() {
                const visited = localStorage.getItem('visited');
                if (!visited && welcomeModalOverlay) {
                    welcomeModalOverlay.classList.add('visible');
                }
            }

            langOptionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = (btn as HTMLElement).dataset.lang as Language;
                    if (lang) {
                        store.setLanguage(lang);
                        localStorage.setItem('visited', 'true');
                        if (welcomeModalOverlay) {
                            welcomeModalOverlay.classList.remove('visible');
                            setTimeout(() => welcomeModalOverlay.remove(), 500);
                        }
                        if (langSelect) langSelect.value = lang;
                    }
                });
            });

            setTimeout(checkFirstVisit, 100);

			if (canvas) {
				sphere = new LotterySphere(canvas, store.getState().candidates);
                lotteryManager.setSphere(sphere);
			}
            
            window.addEventListener('beforeunload', () => {
                if (sphere) sphere.destroy();
            });

			function updateStatus(text: string) {
				if (statusDisplay) statusDisplay.textContent = text;
			}
            
            // --- System Modal Logic ---
            systemConfigBtn?.addEventListener('click', () => {
                systemModalOverlay.classList.add('visible');
                initNameSettings();
                renderPrizeConfigList();
            });

            function closeSystemModal() {
                systemModalOverlay.classList.remove('visible');
            }
            function closeResultModal() {
                resultModalOverlay.classList.remove('visible');
                if (sphere) {
                    const settings = settingsStore.getSettings();
                    sphere.resumeIdleSpin(settings.rotationSpeed);
                }
            }
            closeModalBtn?.addEventListener('click', closeSystemModal);
            systemModalOverlay?.addEventListener('click', (e) => {
                if (e.target === systemModalOverlay) closeSystemModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeSystemModal();
                    closeResultModal();
                }
            });

            tabBtns.forEach((btn) => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = (btn as HTMLElement).dataset.tab;
                    const content = document.getElementById(`tab-${tabId}`);
                    content?.classList.add('active');
                });
            });

            // --- Name Settings Logic ---
            function initNameSettings() {
                const state = store.getState();
                if (namesInput && !namesInput.value && state.candidates.length > 0) {
                    namesInput.value = state.candidates.join('\n');
                    processInput();
                }
            }

            function processInput() {
                if (!namesInput) return [];
                const rawText = namesInput.value;
                const lines = rawText.split('\n');
                const validNames: string[] = [];
                const seen = new Set<string>();
                
                lines.forEach(line => {
                    const clean = line.trim().replace(/\s+/g, ' ');
                    if (!clean) return;
                    if (!seen.has(clean)) {
                        seen.add(clean);
                        validNames.push(clean);
                    }
                });
                
                if (validCountEl) validCountEl.textContent = validNames.length.toString();
                if (saveNamesBtn) saveNamesBtn.disabled = validNames.length === 0;
                return validNames;
            }

            namesInput?.addEventListener('input', processInput);

            saveNamesBtn?.addEventListener('click', async () => {
                const newNames = processInput();
                if (newNames.length === 0) return;
                
                const confirmed = await modalManager.confirm('', { messageKey: 'saveResetConfirm' });
                if (confirmed) {
                    store.setState({
                        candidates: newNames,
                        results: {}
                    });
                    syncWithStore();
                    updateStatus(t('listUpdated'));
                    modalManager.toast('', { messageKey: 'listSaved' });
                }
            });

            importFileBtn?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt,.csv';
                input.onchange = (e) => {
                    const file = (e.target as HTMLInputElement).files?.[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target?.result as string;
                        if (text && namesInput) {
                            namesInput.value = text;
                            processInput();
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });

            importBlobBtn?.addEventListener('click', async () => {
                const password = await modalManager.prompt('', {
                    titleKey: 'confirm',
                    messageKey: 'enterPassword',
                    inputType: 'password',
                    allowOutsideClick: false,
                    allowEsc: true
                });
                if (password === null) return;

                try {
                    const loginRes = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });

                    if (!loginRes.ok) {
                        await modalManager.alert('', { messageKey: 'authFailed' });
                        return;
                    }

                    const namesRes = await fetch('/api/names');
                    if (!namesRes.ok) {
                        await modalManager.alert('', { messageKey: 'cloudImportFailed' });
                        return;
                    }

                    const data = await namesRes.json().catch(() => ({ names: [] }));
                    const incomingNames = Array.isArray(data.names) ? data.names : [];
                    const normalizedNames = incomingNames
                        .map((n: string) => n.trim().replace(/\s+/g, ' '))
                        .filter((n: string) => Boolean(n));
                    const dedupedNames = Array.from(new Set(normalizedNames));

                    if (dedupedNames.length === 0) {
                        await modalManager.alert('', { messageKey: 'noValidNames' });
                        return;
                    }

                    if (namesInput) {
                        namesInput.value = dedupedNames.join('\n');
                        processInput();
                    }

                    store.setState({
                        candidates: dedupedNames,
                        results: {},
                        freeResults: [],
                        freeInitialCandidates: [...dedupedNames]
                    });
                    syncWithStore();
                    updateStatus(t('listUpdated'));
                    modalManager.toast('', { messageKey: 'cloudImportSuccess' });
                } catch (err) {
                    await modalManager.alert('', { messageKey: 'cloudImportFailed' });
                }
            });

            // --- Prize Config Logic ---
            function renderPrizeConfigList() {
                if (!prizeListConfigEl) return;
                prizeListConfigEl.innerHTML = '';
                const state = store.getState();
                
                state.prizes.forEach((p) => {
                    const row = document.createElement('div');
                    row.className = 'prize-config-row';
                    row.innerHTML = `
                        <input type="text" class="prize-title-input" value="${p.title}" placeholder="${t('prizeName')}">
                        <input type="number" class="prize-count-input" value="${p.count}" min="1" placeholder="${t('prizeCount')}">
                        <button class="delete-prize-btn" data-id="${p.id}">üóëÔ∏è</button>
                    `;
                    
                    const titleInput = row.querySelector('.prize-title-input') as HTMLInputElement;
                    const countInput = row.querySelector('.prize-count-input') as HTMLInputElement;
                    const delBtn = row.querySelector('.delete-prize-btn') as HTMLButtonElement;
                    
                    titleInput.addEventListener('change', () => {
                        const newPrizes = state.prizes.map(item => 
                            item.id === p.id ? { ...item, title: titleInput.value } : item
                        );
                        store.updatePrizes(newPrizes);
                        renderPrizeOptions();
                    });
                    
                    countInput.addEventListener('change', () => {
                        let val = parseInt(countInput.value);
                        if (val < 1) val = 1;
                        const newPrizes = state.prizes.map(item => 
                            item.id === p.id ? { ...item, count: val } : item
                        );
                        store.updatePrizes(newPrizes);
                        updateCurrentPrizeInfo();
                    });
                    
                    delBtn.addEventListener('click', async () => {
                        if (state.prizes.length <= 1) {
                            modalManager.alert('', { messageKey: 'atLeastOnePrize' });
                            return;
                        }
                        const confirmed = await modalManager.confirm('', { 
                            messageKey: 'deletePrizeConfirm',
                            messageParams: { prize: p.title }
                        });
                        if (!confirmed) return;
                        
                        const newPrizes = state.prizes.filter(x => x.id !== p.id);
                        let newCurrentId = state.currentPrizeId;
                        if (state.currentPrizeId === p.id) newCurrentId = newPrizes[0].id;
                        
                        store.setState({
                            prizes: newPrizes,
                            currentPrizeId: newCurrentId
                        });
                        renderPrizeConfigList();
                        renderPrizeOptions();
                    });
                    
                    prizeListConfigEl.appendChild(row);
                });
            }

            addPrizeBtn?.addEventListener('click', () => {
                const state = store.getState();
                const newPrize = createPrize(`${t('newPrize')} ${state.prizes.length + 1}`, 1);
                store.updatePrizes([...state.prizes, newPrize]);
                renderPrizeConfigList();
                renderPrizeOptions();
            });

            // --- Animation Settings Logic ---
            function updateAnimationSettingsUI() {
                const settings = settingsStore.getSettings();
                
                if (speedSlider) speedSlider.value = settings.rotationSpeed.toString();
                if (speedInput) speedInput.value = settings.rotationSpeed.toString();
                
                if (turnsSlider) turnsSlider.value = settings.spinTurns.toString();
                if (turnsInput) turnsInput.value = settings.spinTurns.toString();
                
                if (durationSlider) durationSlider.value = settings.spinDuration.toString();
                if (durationInput) durationInput.value = settings.spinDuration.toString();
                
                if (extraRevsSlider) extraRevsSlider.value = settings.extraRevs.toString();
                if (extraRevsInput) extraRevsInput.value = settings.extraRevs.toString();
                
                // Update sphere if initialized
                if (sphere) {
                    sphere.setBaseSpeed(settings.rotationSpeed);
                }
            }

            function setupAnimationSettingsListeners() {
                const bindPair = (slider: HTMLInputElement, input: HTMLInputElement, key: keyof SphereSettings) => {
                    const update = (val: number) => {
                        settingsStore.updateSettings({ [key]: val });
                        updateAnimationSettingsUI();
                    };

                    slider?.addEventListener('input', (e) => {
                        update(parseFloat((e.target as HTMLInputElement).value));
                    });

                    input?.addEventListener('change', (e) => {
                        let val = parseFloat((e.target as HTMLInputElement).value);
                        update(val);
                    });
                };

                bindPair(speedSlider, speedInput, 'rotationSpeed');
                bindPair(turnsSlider, turnsInput, 'spinTurns');
                bindPair(durationSlider, durationInput, 'spinDuration');
                bindPair(extraRevsSlider, extraRevsInput, 'extraRevs');

                restoreDefaultsBtn?.addEventListener('click', () => {
                    settingsStore.resetToDefault();
                    updateAnimationSettingsUI();
                });
            }

            // --- Main Lottery Logic ---
            function renderPrizeOptions() {
                if (!prizeSelect) return;
                const state = store.getState();
                prizeSelect.innerHTML = '';
                state.prizes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.title;
                    prizeSelect.appendChild(option);
                });
                prizeSelect.value = state.currentPrizeId;
                updateCurrentPrizeInfo();
            }

            function updateCurrentPrizeInfo() {
                const state = store.getState();
                const p = state.prizes.find(x => x.id === state.currentPrizeId);
                if (p && drawCountEl) {
                    drawCountEl.textContent = p.count.toString();
                }
            }
            
            prizeSelect?.addEventListener('change', (e) => {
                store.setCurrentPrize((e.target as HTMLSelectElement).value);
                updateCurrentPrizeInfo();
            });

            function renderResultsPanel() {
                if (!winnersContainer) return;
                winnersContainer.innerHTML = '';
                const state = store.getState();
                let hasResults = false;
                
                if (state.mode === 'prize') {
                    state.prizes.forEach(p => {
                        const winners = state.results[p.id] || [];
                        if (winners.length === 0) return;
                        hasResults = true;
                        
                        const group = document.createElement('div');
                        group.className = 'winner-group';
                        group.innerHTML = `<h4>${p.title}</h4>`;
                        
                        const list = document.createElement('div');
                        group.appendChild(list);
                        list.className = 'winner-group-list';
                        list.textContent = winners.join('„ÄÅ');
                        
                        winnersContainer.appendChild(group);
                    });
                } else {
                    hasResults = state.freeResults.length > 0;

                    if (hasResults) {
                        const group = document.createElement('div');
                        group.className = 'winner-group';
                        group.innerHTML = `<h4 data-i18n="freeMode">${t('freeMode')}</h4>`;
                        
                        const list = document.createElement('div');
                        group.appendChild(list);
                        list.className = 'winner-group-list free-results-list';
                        // List names in reverse chronological order
                        list.textContent = state.freeResults.join('„ÄÅ');
                        
                        winnersContainer.appendChild(group);
                    }
                }

                if (!hasResults) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-results';
                    empty.textContent = t('noFreeResults');
                    winnersContainer.appendChild(empty);
                }

                if (clearResultsBtn) clearResultsBtn.disabled = !hasResults;
            }
            
            // --- Mode Switch Logic ---
            modeBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const state = store.getState();
                    const targetMode = (btn as HTMLElement).dataset.mode as any;
                    if (state.mode === targetMode) return;

                    // Confirmation if drawing or result shown
                    const isResultVisible = resultModalOverlay.classList.contains('visible');
                    if (state.isDrawing || isResultVisible) {
                        const confirmed = await modalManager.confirm('', { messageKey: 'modeSwitchConfirm' });
                        if (!confirmed) return;
                        
                        if (isResultVisible) {
                            closeResultModal();
                        }
                    }

                    store.setMode(targetMode);
                    syncWithStore();
                });
            });

            // --- Free Mode Actions ---
            undoBtn?.addEventListener('click', () => {
                store.undoFree();
                syncWithStore();
            });

            resetFreeBtn?.addEventListener('click', async () => {
                const confirmed = await modalManager.confirm('', { messageKey: 'confirmClear' }); // Reuse clear confirm
                if (confirmed) {
                    store.resetFree();
                    syncWithStore();
                    modalManager.toast('', { messageKey: 'resetComplete' });
                }
            });

            clearResultsBtn?.addEventListener('click', async () => {
                const confirmed = await modalManager.confirm('', { messageKey: 'confirmClear' });
                if (confirmed) {
                    if (store.getState().mode === 'free') {
                        store.clearFreeResults();
                        modalManager.toast('', { messageKey: 'resetComplete' });
                    } else {
                        store.clearResults();
                        modalManager.toast('', { messageKey: 'resetComplete' });
                    }
                    syncWithStore();
                    updateStatus(t('ready'));
                }
            });

            startBtn?.addEventListener('click', () => {
                lotteryManager.startDraw();
            });

            nextBtn?.addEventListener('click', () => {
                closeResultModal();
                updateStatus(t('ready'));
            });

            // Init
            setupAnimationSettingsListeners();
            syncWithStore();

            // Subscribe to store for automatic UI updates
            store.subscribe(() => {
                syncWithStore();
            });
		</script>
	</body>
</html>
