---
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Pachinko Sphere</title>
		<style>
			body {
				margin: 0;
				overflow: hidden;
				background-color: #111; /* Dark background to make names pop */
				font-family: system-ui, sans-serif;
				color: white;
			}
			#sphere-container {
				width: 100vw;
				height: 100vh;
				position: relative;
			}
			canvas {
				display: block;
				width: 100%;
				height: 100%;
			}
			
			/* UI Overlay */
			#ui-layer {
				position: absolute;
				bottom: 40px;
				left: 50%;
				transform: translateX(-50%);
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 20px;
				z-index: 10;
				pointer-events: none;
			}
            
            .control-panel {
                background: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                padding: 20px 40px;
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                pointer-events: auto;
            }

            .prize-selector {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 10px;
            }

            #prize-select {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                font-size: 1rem;
                outline: none;
                cursor: pointer;
            }

            #prize-select option {
                background: #222;
                color: white;
            }

            .prize-info {
                font-size: 0.9rem;
                color: #ccc;
            }

            #draw-count {
                color: #ff3366;
                font-weight: bold;
                font-size: 1.1rem;
            }
			
			button {
				pointer-events: auto;
				padding: 12px 32px;
				font-size: 1.2rem;
				font-weight: bold;
				color: #fff;
				background:  rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 50px;
				cursor: pointer;
				transition: all ease 0.2s;
				text-transform: uppercase;
				letter-spacing: 1px;
			}
			
			button:hover {
				background: rgba(255, 255, 255, 0.3); 
                backdrop-filter: blur(12px);
                box-shadow: 0 8px 32px 0 rgba(255, 255, 255, 0.1);
			}
			
			button:active {
				transform: translateY(1px);
			}
			
			button:disabled {
				background: #555;
				cursor: not-allowed;
				box-shadow: none;
				transform: none;
			}

			#status-display {
				font-size: 1.5rem;
				font-weight: bold;
				text-shadow: 0 2px 4px rgba(0,0,0,0.8);
				min-height: 2rem;
			}

            /* Winners Panel */
            #winners-panel {
                position: absolute;
                top: 80px;
                right: 20px;
                width: 260px;
                max-height: calc(100vh - 100px);
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                border-radius: 12px;
                padding: 15px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: column;
                pointer-events: auto;
                z-index: 5;
            }
            
            #winners-panel h3 {
                margin: 0 0 15px 0;
                font-size: 1.1rem;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding-bottom: 10px;
                color: #fff;
            }
            
            #winners-container {
                flex: 1;
                overflow-y: auto;
                margin-bottom: 15px;
            }
            
            .winner-group {
                margin-bottom: 15px;
            }
            
            .winner-group h4 {
                margin: 0 0 5px 0;
                font-size: 0.9rem;
                color: #aaa;
                text-transform: uppercase;
            }
            
            .winner-group-list {
                color: #ffd700;
                font-size: 0.95rem;
                line-height: 1.4;
                word-break: break-all;
            }

            /* Result Modal Overlay */
            #modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(3px);
                z-index: 100;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            
            #modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

			#result-modal {
				background: rgba(20, 20, 20, 0.95);
				padding: 50px 80px;
				border-radius: 20px;
				border: 1px solid rgba(255, 255, 255, 0.2);
				text-align: center;
				box-shadow: 0 0 50px rgba(0,0,0,0.5);
				transform: scale(0.9);
				transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			}
			
            #modal-overlay.visible #result-modal {
                transform: scale(1);
            }
			
			.winner-title {
				font-size: 1.5rem;
				color: #fff;
				margin-bottom: 20px;
				text-transform: uppercase;
				letter-spacing: 2px;
			}
			
			.winner-name {
				font-size: 4rem;
				font-weight: 800;
				background: linear-gradient(45deg, #ffd700, #ffaa00, #ffea00);
                background-size: 200% auto;
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				margin: 0;
                animation: shine 3s linear infinite;
			}
            
            @keyframes shine {
                to {
                    background-position: 200% center;
                }
            }

			.next-btn {
				margin-top: 40px;
                padding: 15px 40px;
                font-size: 1.3rem;
                background: white;
                color: #111;
			}
			
			.next-btn:hover {
                background: #eee;
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
			}

            /* Result Modal Badges */
            #modal-winners-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
                margin: 30px 0;
            }

            .badge {
                background: rgba(255, 215, 0, 0.2);
                border: 1px solid rgba(255, 215, 0, 0.5);
                color: #ffd700;
                padding: 10px 20px;
                border-radius: 50px;
                font-size: 1.5rem;
                font-weight: bold;
                animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            @keyframes popIn {
                from { transform: scale(0); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }

            .highlight-name {
                font-size: 3rem;
                color: #fff;
                font-weight: bold;
                height: 4rem;
                margin-bottom: 20px;
                text-shadow: 0 0 20px rgba(255, 51, 102, 0.8);
            }

            .highlight-name.pop {
                animation: popScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            @keyframes popScale {
                0% { transform: scale(1); }
                50% { transform: scale(1.5); }
                100% { transform: scale(1); }
            }

            /* Prize Config Modal */
            #prize-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 200;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            #prize-modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

            #prize-modal {
                background: #1a1a1a;
                width: 500px;
                max-width: 90%;
                border-radius: 12px;
                padding: 30px;
                border: 1px solid #333;
                display: flex;
                flex-direction: column;
                gap: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            }

            #prize-modal h3 {
                margin: 0;
                color: #fff;
            }

            #prize-list {
                max-height: 300px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .prize-config-row {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .prize-title-input {
                flex: 2;
                background: #222;
                border: 1px solid #444;
                color: white;
                padding: 8px;
                border-radius: 4px;
            }

            .prize-count-input {
                flex: 1;
                background: #222;
                border: 1px solid #444;
                color: white;
                padding: 8px;
                border-radius: 4px;
            }

            .delete-prize-btn {
                background: transparent;
                border: none;
                cursor: pointer;
                font-size: 1.2rem;
                padding: 5px;
                transition: transform 0.2s;
            }

            .delete-prize-btn:hover {
                transform: scale(1.1);
            }

            .dashed-btn {
                background: transparent;
                border: 2px dashed #444;
                color: #888;
                border-radius: 8px;
                padding: 10px;
                cursor: pointer;
                transition: all 0.2s;
                text-transform: none;
                letter-spacing: normal;
                font-size: 1rem;
            }

            .dashed-btn:hover {
                border-color: #666;
                color: #aaa;
                background: rgba(255, 255, 255, 0.05);
                transform: none;
                box-shadow: none;
            }

            .primary-btn {
                background: linear-gradient(45deg, #ff3366, #ff6b6b);
                color: white;
                border: none;
                border-radius: 6px;
                padding: 10px 20px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(255, 51, 102, 0.3);
                font-size: 1rem;
                text-transform: none;
                letter-spacing: normal;
            }

            .primary-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 51, 102, 0.5);
            }
            
            .small {
                padding: 5px 15px;
                font-size: 0.8rem;
                border-radius: 6px;
                text-transform: none;
                letter-spacing: normal;
            }

            /* Settings Button (Top Right) */
            #top-bar {
                position: absolute;
                top: 20px;
                right: 20px;
                z-index: 20;
            }

            #system-config-btn {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                padding: 10px 20px;
                border-radius: 30px;
                color: white;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            #system-config-btn:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateY(-2px);
            }

            /* Unified System Modal */
            #system-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                z-index: 200;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            #system-modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            #system-modal {
                background: rgba(30, 30, 30, 0.8);
                backdrop-filter: blur(20px);
                width: 700px;
                max-width: 90%;
                border-radius: 16px;
                padding: 0;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                max-height: 85vh;
            }
            
            .modal-header {
                padding: 20px 30px;
                background: rgba(0,0,0,0.2);
                border-bottom: 1px solid rgba(255,255,255,0.05);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-tabs {
                display: flex;
                gap: 20px;
            }
            
            .tab-btn {
                background: transparent;
                border: none;
                color: #888;
                font-size: 1rem;
                font-weight: bold;
                padding: 10px 5px;
                cursor: pointer;
                position: relative;
                box-shadow: none;
                transform: none;
                transition: color 0.2s;
                border-radius: 0;
            }
            
            .tab-btn:hover {
                color: #ccc;
                background: transparent;
                transform: none;
                box-shadow: none;
            }
            
            .tab-btn.active {
                color: #fff;
            }
            
            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: -21px; /* Adjust to align with header bottom */
                left: 0;
                width: 100%;
                height: 3px;
                background: #ff3366;
                box-shadow: 0 -2px 10px rgba(255, 51, 102, 0.5);
            }
            
            .close-modal-btn {
                background: transparent;
                border: none;
                color: #666;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0;
                line-height: 1;
                box-shadow: none;
            }
            .close-modal-btn:hover {
                color: #fff;
                background: transparent;
                transform: none;
                box-shadow: none;
            }

            .modal-body {
                padding: 30px;
                overflow-y: auto;
                flex: 1;
            }
            
            .tab-content {
                display: none;
                animation: fadeIn 0.3s ease;
            }
            .tab-content.active {
                display: block;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* Inputs & Forms */
            .input-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                color: #aaa;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }
            
            textarea, input[type="text"], input[type="number"] {
                width: 100%;
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #fff;
                padding: 12px;
                border-radius: 8px;
                font-family: inherit;
                font-size: 1rem;
                box-sizing: border-box;
                transition: border-color 0.2s;
            }
            
            textarea:focus, input:focus {
                outline: none;
                border-color: #ff3366;
                background: rgba(0, 0, 0, 0.5);
            }

            /* Prize List Styling */
            .prize-config-row {
                display: flex;
                gap: 15px;
                align-items: center;
                background: rgba(255, 255, 255, 0.03);
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 10px;
                border: 1px solid transparent;
                transition: border-color 0.2s;
            }
            .prize-config-row:hover {
                border-color: rgba(255, 255, 255, 0.1);
            }

            /* Language Switcher */
            .lang-switcher {
                margin-left: auto;
                margin-right: 20px;
            }
            .lang-select {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #ccc;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 0.9rem;
                cursor: pointer;
                outline: none;
            }
            .lang-select option {
                background: #333;
                color: white;
            }

            /* Welcome Modal */
            #welcome-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(10px);
                z-index: 300;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.5s ease;
            }
            
            #welcome-modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

            #welcome-modal {
                background: rgba(30, 30, 30, 0.6);
                padding: 50px 60px;
                border-radius: 24px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                text-align: center;
                box-shadow: 0 20px 60px rgba(0,0,0,0.6);
                max-width: 90%;
                width: 500px;
                transform: translateY(20px);
                transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            }

            #welcome-modal-overlay.visible #welcome-modal {
                transform: translateY(0);
            }

            .welcome-title {
                font-size: 2rem;
                margin: 0 0 10px 0;
                background: linear-gradient(135deg, #fff, #aaa);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            .welcome-subtitle {
                color: #888;
                margin-bottom: 40px;
                font-size: 1.1rem;
            }

            .language-options {
                display: flex;
                gap: 20px;
                justify-content: center;
                margin-bottom: 30px;
            }

            .lang-option-btn {
                flex: 1;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }

            .lang-option-btn:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.3);
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            }

            .lang-option-btn.selected {
                border-color: #ff3366;
                background: rgba(255, 51, 102, 0.1);
            }

            .lang-name {
                font-size: 1.5rem;
                font-weight: bold;
                color: #fff;
            }

            .lang-desc {
                font-size: 0.9rem;
                color: #aaa;
            }

            .welcome-note {
                font-size: 0.9rem;
                color: #666;
                line-height: 1.6;
                margin: 0;
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.05);
            }
		</style>
	</head>
	<body>
		<div id="sphere-container">
            <div id="top-bar">
                <button id="system-config-btn" data-i18n="systemConfig">‚öôÔ∏è Á≥ªÁªüÈÖçÁΩÆ</button>
            </div>
			<canvas id="lottery-canvas"></canvas>
			
			<div id="ui-layer">
                <div class="control-panel">
                    <div class="prize-selector">
                        <select id="prize-select">
                            <!-- Prizes will be populated here -->
                        </select>
                        <div class="prize-info">
                            <span data-i18n="drawing">Êú¨Ê¨°ÊäΩÂèñ</span> <span id="draw-count">0</span> <span data-i18n="people">‰∫∫</span>
                        </div>
                    </div>
                    <div id="status-display" data-i18n="ready">ÂáÜÂ§áÂ∞±Áª™</div>
                    <button id="start-btn" data-i18n="startLottery">ÂºÄÂßãÊäΩÂ•ñ</button>
                </div>
			</div>
            
            <div id="winners-panel">
                <h3 data-i18n="lotteryResults">‰∏≠Â•ñÁªìÊûú</h3>
                <div id="winners-container">
                    <!-- Results grouped by prize -->
                </div>
                <button id="clear-results-btn" class="secondary-btn small" data-i18n="clearResults">Ê∏ÖÁ©∫ÁªìÊûú</button>
            </div>
			
            <div id="modal-overlay">
                <div id="result-modal">
                    <div class="winner-title" id="modal-title" data-i18n="congrats">üéâ ÊÅ≠Âñú üéâ</div>
                    <div id="modal-winners-list">
                        <!-- Winners shown here -->
                    </div>
                    <div id="current-highlight" class="highlight-name"></div>
                    <button class="next-btn" id="next-btn" data-i18n="nextRound">‰∏ã‰∏ÄËΩÆ</button>
                </div>
            </div>

            <!-- Unified System Modal -->
            <div id="system-modal-overlay">
                <div id="system-modal">
                    <div class="modal-header">
                        <div class="modal-tabs">
                            <button class="tab-btn active" data-tab="names" data-i18n="nameSettings">ÂêçÂçïËÆæÁΩÆ</button>
                            <button class="tab-btn" data-tab="prizes" data-i18n="prizeSettings">Â•ñÈ°πÈÖçÁΩÆ</button>
                        </div>
                        <div class="lang-switcher">
                            <select id="lang-select" class="lang-select">
                                <option value="zh">‰∏≠Êñá</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <button class="close-modal-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Names Tab -->
                        <div id="tab-names" class="tab-content active">
                            <div class="input-group">
                                <label data-i18n="candidateList">ÂÄôÈÄâÂêçÂçïÔºàÊØèË°å‰∏Ä‰∏™ÂêçÂ≠óÔºâ</label>
                                <textarea id="names-input" placeholder="ËØ∑ËæìÂÖ•ÊàñÁ≤òË¥¥ÂßìÂêçÔºåÊØèË°å‰∏Ä‰∏™..." rows="15"></textarea>
                            </div>
                            <div class="stats-bar" style="display: flex; justify-content: space-between; align-items: center; color: #888;">
                                <span><span data-i18n="imported">Â∑≤ÂØºÂÖ•:</span> <strong id="valid-count" style="color: #fff">0</strong> <span data-i18n="people">‰∫∫</span></span>
                                <div style="display: flex; gap: 10px;">
                                    <button id="import-file-btn" class="dashed-btn" data-i18n="importFile">üìÇ ÂØºÂÖ•Êñá‰ª∂</button>
                                    <button id="save-names-btn" class="primary-btn" data-i18n="saveNames">‰øùÂ≠òÂêçÂçï</button>
                                </div>
                            </div>
                        </div>

                        <!-- Prizes Tab -->
                        <div id="tab-prizes" class="tab-content">
                            <div id="prize-list-config">
                                <!-- Prize rows will be generated here -->
                            </div>
                            <button id="add-prize-btn" class="dashed-btn" style="width: 100%; margin-top: 15px;" data-i18n="addPrize">+ Ê∑ªÂä†Êñ∞Â•ñÈ°π</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Welcome / Language Selection Modal -->
            <div id="welcome-modal-overlay">
                <div id="welcome-modal">
                    <h1 class="welcome-title">Welcome / Ê¨¢Ëøé</h1>
                    <p class="welcome-subtitle">Please select your language / ËØ∑ÈÄâÊã©ËØ≠Ë®Ä</p>
                    <div class="language-options">
                        <button class="lang-option-btn" data-lang="zh">
                            <span class="lang-name">‰∏≠Êñá</span>
                            <span class="lang-desc">Chinese</span>
                        </button>
                        <button class="lang-option-btn" data-lang="en">
                            <span class="lang-name">English</span>
                            <span class="lang-desc">Ëã±ËØ≠</span>
                        </button>
                    </div>
                    <p class="welcome-note">
                        You can change this later in settings.<br>
                        Á®çÂêéÂèØ‰ª•Âú®ËÆæÁΩÆ‰∏≠‰øÆÊîπ„ÄÇ
                    </p>
                </div>
            </div>
		</div>

		<script>
			import { LotterySphere } from '../components/LotterySphere';
			import names from '../data/name';
            import { createPrize, validatePrizeList } from '../lib/prizeConfigState';
            import { drawWinners } from '../lib/drawEngine';
            import type { Prize } from '../lib/types';
            import { translations, type Language } from '../lib/i18n';

			const canvas = document.getElementById('lottery-canvas') as HTMLCanvasElement;
			const startBtn = document.getElementById('start-btn') as HTMLButtonElement;
			const statusDisplay = document.getElementById('status-display') as HTMLDivElement;
            
            // System Modal Elements
            const systemConfigBtn = document.getElementById('system-config-btn') as HTMLButtonElement;
            const systemModalOverlay = document.getElementById('system-modal-overlay') as HTMLDivElement;
            const closeModalBtn = document.querySelector('.close-modal-btn') as HTMLButtonElement;
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const langSelect = document.getElementById('lang-select') as HTMLSelectElement;

            // Settings Elements (inside System Modal)
            const namesInput = document.getElementById('names-input') as HTMLTextAreaElement;
            const validCountEl = document.getElementById('valid-count') as HTMLElement;
            const saveNamesBtn = document.getElementById('save-names-btn') as HTMLButtonElement;
            const importFileBtn = document.getElementById('import-file-btn') as HTMLButtonElement;

            // Prize Config Elements (inside System Modal)
            const prizeListConfigEl = document.getElementById('prize-list-config') as HTMLDivElement;
            const addPrizeBtn = document.getElementById('add-prize-btn') as HTMLButtonElement;

            // Main UI Elements
            const prizeSelect = document.getElementById('prize-select') as HTMLSelectElement;
            const drawCountEl = document.getElementById('draw-count') as HTMLSpanElement;
            const winnersContainer = document.getElementById('winners-container') as HTMLDivElement;
            const clearResultsBtn = document.getElementById('clear-results-btn') as HTMLButtonElement;

			// Result Modal Elements
            const resultModalOverlay = document.getElementById('modal-overlay') as HTMLDivElement;
            const modalTitle = document.getElementById('modal-title') as HTMLDivElement;
            const modalWinnersList = document.getElementById('modal-winners-list') as HTMLDivElement;
            const currentHighlight = document.getElementById('current-highlight') as HTMLDivElement;
			const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
			
			let sphere: LotterySphere | null = null;
			let isLotteryRunning = false;
            
            // State
            let currentNamesList = [...names];
            let prizes: Prize[] = [
                createPrize('‰∏ÄÁ≠âÂ•ñ', 1, 'Â§ßÂ•ñ'),
                createPrize('‰∫åÁ≠âÂ•ñ', 2),
                createPrize('‰∏âÁ≠âÂ•ñ', 5)
            ];
            let results: Record<string, string[]> = {};
            let currentPrizeId = prizes[0].id;

            // I18n Logic
            let currentLang: Language = (localStorage.getItem('lang') as Language) || 'zh';

            function t(key: keyof typeof translations['zh'], params: Record<string, string | number> = {}) {
                // @ts-ignore
                let text = translations[currentLang][key] || key;
                Object.entries(params).forEach(([k, v]) => {
                    text = text.replace(`{${k}}`, String(v));
                });
                return text;
            }

            function updateLanguage(lang: Language) {
                currentLang = lang;
                localStorage.setItem('lang', lang);
                
                // Update simple elements
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n') as keyof typeof translations['zh'];
                    if (key && translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });

                // Update inputs placeholders
                if (namesInput) namesInput.placeholder = t('candidatePlaceholder');
                
                // Re-render prize config to update placeholders
                renderPrizeConfigList();
                
                // Update status if idle
                if (!isLotteryRunning && statusDisplay) {
                    // Only reset if it's "Ready" or "Finished" (simple check)
                    // Or just always reset to Ready if idle
                    updateStatus(t('ready'));
                }

                // Update select dropdown options if needed (though prizes titles are data, not i18n keys)
                // But we should update the static text around it
            }

            if (langSelect) {
                langSelect.value = currentLang;
                langSelect.addEventListener('change', (e) => {
                    updateLanguage((e.target as HTMLSelectElement).value as Language);
                });
            }

            // --- Welcome Modal Logic ---
            const welcomeModalOverlay = document.getElementById('welcome-modal-overlay');
            const langOptionBtns = document.querySelectorAll('.lang-option-btn');

            function checkFirstVisit() {
                const visited = localStorage.getItem('visited');
                if (!visited && welcomeModalOverlay) {
                    welcomeModalOverlay.classList.add('visible');
                }
            }

            langOptionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = (btn as HTMLElement).dataset.lang as Language;
                    if (lang) {
                        updateLanguage(lang);
                        localStorage.setItem('visited', 'true');
                        if (welcomeModalOverlay) {
                            welcomeModalOverlay.classList.remove('visible');
                        }
                        
                        // Sync with system modal selector
                        if (langSelect) langSelect.value = lang;
                    }
                });
            });

            // Call checkFirstVisit on load
            // We use setTimeout to ensure transition works and it feels like a proper entry
            setTimeout(checkFirstVisit, 100);

            // Initial call
            updateLanguage(currentLang);

			if (canvas) {
				sphere = new LotterySphere(canvas, currentNamesList);
			}
            
            window.addEventListener('beforeunload', () => {
                if (sphere) sphere.destroy();
            });

			function updateStatus(text: string) {
				if (statusDisplay) statusDisplay.textContent = text;
			}
            
            // --- System Modal Logic ---

            // Open
            systemConfigBtn?.addEventListener('click', () => {
                systemModalOverlay.classList.add('visible');
                // Initialize data in tabs
                initNameSettings();
                renderPrizeConfigList();
            });

            // Close
            function closeSystemModal() {
                systemModalOverlay.classList.remove('visible');
            }
            closeModalBtn?.addEventListener('click', closeSystemModal);
            systemModalOverlay?.addEventListener('click', (e) => {
                if (e.target === systemModalOverlay) closeSystemModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeSystemModal();
                    resultModalOverlay.classList.remove('visible');
                }
            });

            // Tabs
            tabBtns.forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    // Deactivate all
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Activate current
                    btn.classList.add('active');
                    // Find the tab content that matches the data-tab
                    const tabId = (btn as HTMLElement).dataset.tab;
                    const content = document.getElementById(`tab-${tabId}`);
                    content?.classList.add('active');
                });
            });

            // --- Name Settings Logic ---

            function initNameSettings() {
                // If textarea is empty but we have names, fill it
                if (namesInput && !namesInput.value && currentNamesList.length > 0) {
                    namesInput.value = currentNamesList.join('\n');
                    processInput();
                }
            }

            function processInput() {
                if (!namesInput) return [];
                const rawText = namesInput.value;
                const lines = rawText.split('\n');
                
                const validNames: string[] = [];
                const seen = new Set<string>();
                
                lines.forEach(line => {
                    const clean = line.trim().replace(/\s+/g, ' ');
                    if (!clean) return;
                    
                    if (!seen.has(clean)) {
                        seen.add(clean);
                        validNames.push(clean);
                    }
                });
                
                // Update UI
                if (validCountEl) validCountEl.textContent = validNames.length.toString();
                
                if (validNames.length === 0) {
                    if (saveNamesBtn) saveNamesBtn.disabled = true;
                } else {
                    if (saveNamesBtn) saveNamesBtn.disabled = false;
                }
                
                return validNames;
            }

            namesInput?.addEventListener('input', processInput);

            saveNamesBtn?.addEventListener('click', () => {
                const newNames = processInput();
                if (newNames.length === 0) return;
                
                if (confirm(t('saveResetConfirm'))) {
                    currentNamesList = newNames;
                    results = {};
                    renderResultsPanel();
                    sphere?.setNames(newNames);
                    
                    updateStatus(t('listUpdated'));
                    // Optional: Close modal or just give feedback
                    alert(t('listSaved'));
                }
            });

            importFileBtn?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt,.csv';
                input.onchange = (e) => {
                    const file = (e.target as HTMLInputElement).files?.[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target?.result as string;
                        if (text && namesInput) {
                            namesInput.value = text;
                            processInput();
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });

            // --- Prize Config Logic ---

            function renderPrizeConfigList() {
                if (!prizeListConfigEl) return;
                prizeListConfigEl.innerHTML = '';
                prizes.forEach((p) => {
                    const row = document.createElement('div');
                    row.className = 'prize-config-row';
                    row.innerHTML = `
                        <input type="text" class="prize-title-input" value="${p.title}" placeholder="${t('prizeName')}">
                        <input type="number" class="prize-count-input" value="${p.count}" min="1" placeholder="${t('prizeCount')}">
                        <button class="delete-prize-btn" data-id="${p.id}">üóëÔ∏è</button>
                    `;
                    
                    const titleInput = row.querySelector('.prize-title-input') as HTMLInputElement;
                    const countInput = row.querySelector('.prize-count-input') as HTMLInputElement;
                    const delBtn = row.querySelector('.delete-prize-btn') as HTMLButtonElement;
                    
                    titleInput.addEventListener('change', () => {
                        p.title = titleInput.value;
                        renderPrizeOptions(); // Live update dropdown
                    });
                    
                    countInput.addEventListener('change', () => {
                        let val = parseInt(countInput.value);
                        if (val < 1) val = 1;
                        p.count = val;
                        updateCurrentPrizeInfo();
                    });
                    
                    delBtn.addEventListener('click', () => {
                        if (prizes.length <= 1) {
                            alert(t('atLeastOnePrize'));
                            return;
                        }
                        if (!confirm(t('deletePrizeConfirm', { prize: p.title }))) return;
                        
                        prizes = prizes.filter(x => x.id !== p.id);
                        if (currentPrizeId === p.id) currentPrizeId = prizes[0].id;
                        renderPrizeConfigList();
                        renderPrizeOptions();
                    });
                    
                    prizeListConfigEl.appendChild(row);
                });
            }

            addPrizeBtn?.addEventListener('click', () => {
                prizes.push(createPrize(`${t('newPrize')} ${prizes.length + 1}`, 1));
                renderPrizeConfigList();
                renderPrizeOptions();
            });

            // --- Main Lottery Logic ---

            function renderPrizeOptions() {
                if (!prizeSelect) return;
                prizeSelect.innerHTML = '';
                prizes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.title;
                    prizeSelect.appendChild(option);
                });
                prizeSelect.value = currentPrizeId;
                updateCurrentPrizeInfo();
            }

            function updateCurrentPrizeInfo() {
                const p = prizes.find(x => x.id === currentPrizeId);
                if (p && drawCountEl) {
                    drawCountEl.textContent = p.count.toString();
                }
            }
            
            prizeSelect?.addEventListener('change', (e) => {
                currentPrizeId = (e.target as HTMLSelectElement).value;
                updateCurrentPrizeInfo();
            });

            function renderResultsPanel() {
                if (!winnersContainer) return;
                winnersContainer.innerHTML = '';
                
                prizes.forEach(p => {
                    const winners = results[p.id] || [];
                    if (winners.length === 0) return;
                    
                    const group = document.createElement('div');
                    group.className = 'winner-group';
                    group.innerHTML = `<h4>${p.title}</h4>`;
                    
                    const list = document.createElement('div');
                    group.appendChild(list);
                    list.className = 'winner-group-list';
                    list.textContent = winners.join('„ÄÅ');
                    
                    winnersContainer.appendChild(group);
                });
            }
            
            clearResultsBtn?.addEventListener('click', () => {
                if (confirm(t('confirmClear'))) {
                    results = {};
                    renderResultsPanel();
                    
                    // Restore names from full list (or just reload page? No, better state reset)
                    // Actually, we should restore to what's in the Name Settings or original
                    // Let's assume processInput gives us the "Configured" list
                    const namesToRestore = processInput(); 
                    if (namesToRestore.length > 0) {
                        currentNamesList = namesToRestore;
                    }
                    
                    sphere?.setNames(currentNamesList);
                    updateStatus(t('resetComplete'));
                    startBtn.disabled = false;
                }
            });

            startBtn?.addEventListener('click', () => {
                if (isLotteryRunning) return;
                
                const prize = prizes.find(p => p.id === currentPrizeId);
                if (!prize) return;
                
                // Check if we need to overwrite
                const existingWinners = results[prize.id];
                if (existingWinners && existingWinners.length > 0) {
                    if (!confirm(t('prizeOverwriteConfirm', { prize: prize.title }))) {
                        return;
                    }
                    
                    // Rollback candidates
                    // Add existing winners back to pool
                    currentNamesList.push(...existingWinners);
                    // Clear result
                    delete results[prize.id];
                    // Visual update (re-add names to sphere if we removed them)
                    sphere?.setNames(currentNamesList);
                    // Update sidebar
                    renderResultsPanel();
                }
                
                if (currentNamesList.length < prize.count) {
                    alert(t('insufficientCandidates', { count: currentNamesList.length, needed: prize.count }));
                    return;
                }
                
                isLotteryRunning = true;
                startBtn.disabled = true;
                systemConfigBtn.disabled = true;
                prizeSelect.disabled = true;
                updateStatus(t('drawingStatus', { prize: prize.title }));
                
                // 1. Start spinning
                sphere?.spin();
                
                // 2. Draw winners
                const { winners, remainingCandidates } = drawWinners(currentNamesList, prize.count);
                
                // 3. Stop after delay
                setTimeout(() => {
                    sphere?.stopAndHighlightWinners(
                        winners, 
                        (name) => {
                            if (currentHighlight) {
                                currentHighlight.textContent = name;
                                currentHighlight.classList.remove('pop');
                                void currentHighlight.offsetWidth;
                                currentHighlight.classList.add('pop');
                            }
                        },
                        () => {
                            // Finished
                            isLotteryRunning = false;
                            updateStatus(t('drawComplete'));
                            
                            // Commit results
                            currentNamesList = remainingCandidates;
                            results[prize.id] = winners;
                            
                            // Show modal
                            resultModalOverlay.classList.add('visible');
                            if (modalTitle) modalTitle.textContent = t('prizeResult', { prize: prize.title });
                            if (modalWinnersList) {
                                modalWinnersList.innerHTML = winners.map(w => `<span class="badge">${w}</span>`).join('');
                            }
                            if (currentHighlight) currentHighlight.textContent = '';
                            
                            renderResultsPanel();
                            
                            // Remove winners from sphere (visual only, state is already updated)
                            sphere?.setNames(currentNamesList);
                        }
                    );
                }, 3000);
            });

            nextBtn?.addEventListener('click', () => {
                resultModalOverlay.classList.remove('visible');
                updateStatus(t('ready'));
                
                startBtn.disabled = false;
                systemConfigBtn.disabled = false;
                prizeSelect.disabled = false;
            });

            // Init
            renderPrizeOptions();
		</script>
	</body>
</html>
